import os
import json
import logging
import httpx
from openai import AsyncOpenAI

logger = logging.getLogger(__name__)

# Настройка клиентов
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
FAL_KEY = os.getenv("FAL_KEY")
AI_PROXY_URL = os.getenv("AI_PROXY_URL")  # Например: "http://user:pass@proxy:8080"

# Логируем состояние при запуске
print("--- AI SERVICE STARTUP ---")
print(f"DEBUG: OpenRouter Key present: {bool(OPENROUTER_API_KEY)}")
print(f"DEBUG: Proxy URL present: {bool(AI_PROXY_URL)}")
if AI_PROXY_URL:
    safe_proxy = AI_PROXY_URL.split('@')[-1] if '@' in AI_PROXY_URL else 'CONFIGURED'
    print(f"DEBUG: Proxy Address: {safe_proxy}")
print("--------------------------")

# Настройка прокси для Fal.ai (системные переменные)
if AI_PROXY_URL:
    os.environ["HTTP_PROXY"] = AI_PROXY_URL
    os.environ["HTTPS_PROXY"] = AI_PROXY_URL

# Создаём HTTP-клиент с прокси если задан
http_client = None
if AI_PROXY_URL:
    http_client = httpx.AsyncClient(
        proxies={
            "http://": AI_PROXY_URL,
            "https://": AI_PROXY_URL
        },
        verify=False  # Отключаем проверку SSL для прокси
    )
    logger.info(f"AI proxy enabled: {safe_proxy}")

client = AsyncOpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=OPENROUTER_API_KEY,
    http_client=http_client,
)

if not OPENROUTER_API_KEY:
    logger.warning("OPENROUTER_API_KEY is not set!")

# ==============================================================================
# ЕДИНЫЙ ИСТОЧНИК МОДЕЛЕЙ (MASTER CONFIG - DEC 2025)
# ==============================================================================

AI_MODELS_GROUPS = [
    {
        "name": "OpenAI (ChatGPT)",
        # Оптимизированная SVG (без width/height)
        "icon": """<svg viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M109.128 54.5666C110.018 51.9282 110.472 49.1658 110.472 46.3851C110.472 41.784 109.23 37.2659 106.874 33.2954C102.139 25.1636 93.3561 20.1432 83.8507 20.1432C81.9781 20.1432 80.1107 20.3383 78.2795 20.7253C75.8166 17.9874 72.7935 15.7957 69.4094 14.2947C66.0254 12.7938 62.3573 12.0177 58.647 12.0176H58.4804L58.4179 12.0179C46.9051 12.0179 36.6952 19.3479 33.1561 30.1539C29.4926 30.8943 26.0317 32.3983 23.005 34.5652C19.9783 36.7322 17.4557 39.5121 15.606 42.7189C13.2569 46.7133 12.019 51.2492 12.0176 55.8674C12.0185 62.3578 14.4602 68.617 18.87 73.4329C17.9799 76.0712 17.5259 78.8337 17.5255 81.6143C17.5259 86.2155 18.768 90.7335 21.1242 94.7041C23.9262 99.5176 28.2051 103.329 33.344 105.588C38.4828 107.847 44.2161 108.437 49.717 107.274C52.1802 110.012 55.2036 112.203 58.5879 113.704C61.9722 115.205 65.6405 115.982 69.3509 115.982H69.5176L69.5853 115.982C81.1043 115.982 91.3108 108.651 94.85 97.8354C98.5135 97.0947 101.974 95.5906 105.001 93.4236C108.028 91.2566 110.551 88.4768 112.4 85.2701C114.747 81.2791 115.983 76.747 115.982 72.1331C115.981 65.6428 113.539 59.3838 109.129 54.568L109.128 54.5666ZM69.5242 109.185H69.497C64.8877 109.184 60.4248 107.588 56.8843 104.676C57.0945 104.564 57.3023 104.448 57.5074 104.328L78.487 92.3706C79.0106 92.0766 79.4459 91.651 79.7488 91.1372C80.0517 90.6234 80.2113 90.0396 80.2115 89.4452V60.2418L89.0791 65.2939C89.1256 65.3168 89.1657 65.3506 89.1958 65.3925C89.2259 65.4343 89.2451 65.4829 89.2516 65.5338V89.7018C89.2394 100.447 80.4149 109.163 69.5242 109.185ZM27.0997 91.3068C25.3668 88.3503 24.4538 84.9956 24.4526 81.5802C24.4526 80.4663 24.5512 79.3495 24.7432 78.2519C24.8992 78.3441 25.1714 78.5081 25.3667 78.6188L46.3463 90.5758C46.8693 90.8771 47.4641 91.0358 48.0698 91.0357C48.6755 91.0355 49.2702 90.8766 49.7931 90.5751L75.407 75.9823V86.0867L75.4073 86.1041C75.4073 86.1528 75.3959 86.2008 75.3738 86.2443C75.3518 86.2878 75.3198 86.3257 75.2804 86.3549L54.072 98.4371C51.0711 100.141 47.6696 101.039 44.2072 101.04C40.7411 101.039 37.3361 100.14 34.3335 98.4311C31.3309 96.7227 28.8363 94.2654 27.0997 91.3057V91.3068ZM21.5804 46.1162C23.8846 42.1672 27.5229 39.1435 31.8586 37.5743C31.8586 37.7525 31.8483 38.0683 31.8483 38.2875V62.2018L31.848 62.2214C31.8481 62.8152 32.0074 63.3984 32.3099 63.9118C32.6123 64.4251 33.047 64.8504 33.5699 65.1443L59.1837 79.7349L50.3166 84.787C50.2728 84.8154 50.2226 84.8328 50.1705 84.8374C50.1183 84.8421 50.0657 84.834 50.0175 84.8138L28.8069 72.7215C25.8085 71.0076 23.3192 68.5462 21.5886 65.5841C19.8581 62.6219 18.9469 59.2629 18.9465 55.8438C18.9479 52.4301 19.8564 49.0764 21.5815 46.1173L21.5804 46.1162ZM94.4362 62.8446L68.8223 48.2522L77.6899 43.202C77.7336 43.1735 77.7838 43.1561 77.836 43.1514C77.8882 43.1468 77.9407 43.1549 77.9889 43.1751L99.1992 55.2573C102.2 56.9685 104.692 59.4285 106.425 62.3904C108.157 65.3523 109.07 68.7118 109.071 72.1317C109.071 80.2943 103.908 87.5981 96.1467 90.4172V65.7878C96.1478 65.7788 96.1478 65.7693 96.1478 65.7603C96.1476 65.1687 95.9893 64.5876 95.6888 64.0757C95.3882 63.5637 94.9562 63.1391 94.4362 62.8446ZM103.262 49.7378C103.056 49.6131 102.848 49.4909 102.639 49.3712L81.6594 37.4139C81.1363 37.1131 80.5418 36.9546 79.9364 36.9543C79.3309 36.9546 78.7364 37.1131 78.2133 37.4139L52.5991 52.0066V41.9022L52.5988 41.8848C52.5988 41.7861 52.6462 41.6931 52.726 41.634L73.9344 29.5619C76.9343 27.8555 80.3361 26.9572 83.7989 26.957C94.7036 26.957 103.547 35.6825 103.547 46.4421C103.546 47.5463 103.451 48.6484 103.262 49.7367V49.7378ZM47.778 67.7471L38.9086 62.6951C38.8621 62.6722 38.822 62.6383 38.7919 62.5964C38.7618 62.5546 38.7426 62.5061 38.7361 62.4552V38.2868C38.7409 27.533 47.5841 18.8147 58.4841 18.8147C63.1005 18.8157 67.571 20.4114 71.1196 23.3249C70.9599 23.4109 70.6815 23.5626 70.4964 23.6733L49.5168 35.6303C48.9934 35.9241 48.5581 36.3495 48.2553 36.8631C47.9524 37.3768 47.7928 37.9604 47.7927 38.5546V38.5739L47.778 67.7471ZM52.5951 57.4997L64.003 50.9983L75.411 57.4953V70.4936L64.003 76.991L52.5951 70.4936V57.4997Z"/></svg>""",
        "models": [
            {"id": "openai/gpt-5.2", "name": "GPT-5.2", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5.2-chat", "name": "GPT-5.2 Chat", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5.2-pro", "name": "GPT-5.2 Pro", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5.1", "name": "GPT-5.1", "cost_input": 0.15, "cost_output": 0.6},
            {"id": "openai/gpt-5.1-codex", "name": "GPT-5.1 Codex", "cost_input": 0.15, "cost_output": 0.6},
            {"id": "openai/gpt-5.1-codex-max", "name": "GPT-5.1 Codex Max", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-5.1-codex-mini", "name": "GPT-5.1 Codex Mini", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-5.1-chat", "name": "GPT-5.1 Chat", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5-mini", "name": "GPT-5 Mini", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5-chat", "name": "GPT-5 Chat", "cost_input": 15, "cost_output": 60},
            {"id": "openai/gpt-5-nano", "name": "GPT-5 Nano", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5-codex", "name": "GPT-5 Codex", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-5", "name": "GPT-5", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/o1-preview", "name": "o1 Preview", "cost_input": 15, "cost_output": 60},
            {"id": "openai/o1-mini", "name": "o1 Mini", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-oss-120b", "name": "GPT OSS 120B", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-oss-20b", "name": "GPT OSS 20B", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-4.1-mini", "name": "GPT-4.1 Mini", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-4.1", "name": "GPT-4.1", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-4.1-nano", "name": "GPT-4.1 Nano", "cost_input": 3, "cost_output": 12},
            {"id": "openai/gpt-4o", "name": "GPT-4o", "cost_input": 2.5, "cost_output": 10},
            {"id": "openai/gpt-4o-mini", "name": "GPT-4o Mini", "cost_input": 0.15, "cost_output": 0.6},
        ]
    },
    {
        "name": "Anthropic",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path d="M32.4286 81.1404L52.8708 69.6696L53.2129 68.6699L52.8708 68.1174H51.8711L48.4509 67.9069L36.7696 67.5912L26.6406 67.1702L16.8273 66.6441L14.3543 66.1179L12.0391 63.066L12.2758 61.5401L14.3543 60.1457L17.3272 60.4088L23.9045 60.8561L33.7704 61.5401L40.9265 61.961L51.5291 63.066H53.2129L53.4496 62.382L52.8708 61.961L52.4236 61.5401L42.2156 54.6208L31.1658 47.3069L25.3778 43.0974L22.247 40.9664L20.6685 38.9669L19.9844 34.5995L22.8258 31.4688L26.6406 31.7318L27.6141 31.9949L31.4815 34.9679L39.7426 41.361L50.5293 49.3064L52.1079 50.6218L52.7393 50.1746L52.8182 49.8588L52.1079 48.6749L46.2409 38.0723L39.9794 27.2856L37.1906 22.8131L36.4539 20.1295C36.1908 19.0245 36.0067 18.1037 36.0067 16.9724L39.2427 12.5788L41.0317 12L45.3464 12.5788L47.1618 14.1573L49.8453 20.2874L54.1863 29.9428L60.9214 43.0711L62.8946 46.9648L63.947 50.5692L64.3416 51.6742H65.0257V51.0428L65.5781 43.6499L66.6042 34.5732L67.604 22.892L67.946 19.6033L69.5771 15.657L72.8132 13.5259L75.3388 14.7361L77.4173 17.7091L77.1279 19.6296L75.8913 27.6539L73.4709 40.2297L71.8923 48.6486H72.8132L73.8655 47.5963L78.1276 41.9398L85.2837 32.9947L88.4408 29.443L92.1241 25.5229L94.4919 23.6549H98.9644L102.253 28.5484L100.78 33.5998L96.1757 39.4404L92.3608 44.3865L86.8885 51.7531L83.4684 57.6463L83.7841 58.1199L84.5996 58.041L96.9649 55.4101L103.647 54.1999L111.619 52.8318L115.223 54.5156L115.618 56.2257L114.197 59.7248L105.673 61.8295L95.6758 63.829L80.7848 67.3544L80.6007 67.486L80.8111 67.7491L87.52 68.3805L90.3877 68.5383H97.4122L110.488 69.5118L113.908 71.7743L115.96 74.5368L115.618 76.6415L110.356 79.3251L103.253 77.6413L86.6781 73.6949L80.9953 72.2742H80.206V72.7478L84.9417 77.3782L93.6237 85.2183L104.489 95.321L105.042 97.8204L103.647 99.7936L102.174 99.5831L92.6239 92.4007L88.9407 89.1647L80.6007 82.1401H80.0482V82.8768L81.9687 85.6919L92.1241 100.951L92.6502 105.634L91.9136 107.16L89.2827 108.081L86.3887 107.555L80.4428 99.2148L74.3128 89.8224L69.3667 81.4035L68.7616 81.7455L65.8412 113.185L64.4732 114.79L61.3161 116L58.6852 114L57.2908 110.764L58.6852 104.371L60.3689 96.0314L61.737 89.4015L62.9735 81.1667L63.7102 78.4306L63.6576 78.2464L63.0525 78.3253L56.8435 86.8495L47.3985 99.6094L39.9267 107.607L38.1377 108.318L35.0332 106.713L35.3226 103.845L37.059 101.293L47.3985 88.1386L53.6338 79.9828L57.6591 75.2735L57.6328 74.5894H57.396L29.9293 92.427L25.0358 93.0584L22.931 91.0853L23.1941 87.8492L24.1939 86.7969L32.455 81.1141L32.4286 81.1404Z" fill="currentColor"/>
</svg>""",
        "models": [
            {"id": "anthropic/claude-sonnet-4.5", "name": "Claude 4.5 Sonnet", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-opus-4.5", "name": "Claude 4.5 Opus", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-haiku-4.5", "name": "Claude 4.5 Haiku", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-sonnet-4", "name": "Claude 4 Sonnet", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-opus-4", "name": "Claude 4 Opus", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-3.7-sonnet", "name": "Claude 3.7 Sonnet", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-3.7-sonnet:thinking", "name": "Claude 3.7 Thinking", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-3.5-sonnet", "name": "Claude 3.5 Sonnet", "cost_input": 3, "cost_output": 15},
            {"id": "anthropic/claude-3-opus", "name": "Claude 3 Opus", "cost_input": 15, "cost_output": 75},
            {"id": "anthropic/claude-3-haiku", "name": "Claude 3 Haiku", "cost_input": 0.25, "cost_output": 1.25},
        ]
    },
    {
        "name": "Google",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path d="M63.892 8C62.08 38.04 38.04 62.08 8 63.892V64.108C38.04 65.92 62.08 89.96 63.892 120H64.108C65.92 89.96 89.96 65.92 120 64.108V63.892C89.96 62.08 65.92 38.04 64.108 8H63.892Z" fill="currentColor"/>
</svg>""",
        "models": [
            {"id": "google/gemini-3-pro-preview", "name": "Gemini 3 Pro", "cost_input": 3.5, "cost_output": 10.5},
            {"id": "google/gemini-3-flash-preview", "name": "Gemini 3 Flash", "cost_input": 3.5, "cost_output": 10.5},
            {"id": "google/gemini-2.5-flash", "name": "Gemini 2.5 Flash", "cost_input": 3.5, "cost_output": 10.5},
            {"id": "google/gemini-2.5-flash-lite", "name": "Gemini 2.5 Flash Lite", "cost_input": 3.5, "cost_output": 10.5},
            {"id": "google/gemini-2.0-flash-exp:free", "name": "Gemini 2.0 Free", "cost_input": 3.5, "cost_output": 10.5},
        ]
    },
    {
        "name": "xAI (Grok)",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path d="M64.2057 109.714L21.1674 46.9085H40.2926L83.336 109.714H64.2057Z" fill="currentColor"/>
<path d="M21.1429 109.714L40.2783 81.7908L49.848 95.7553L40.288 109.714H21.1429Z" fill="currentColor"/>
<path d="M54.636 60.8376L87.712 12.5714H106.857L64.2057 74.8062L54.636 60.8376Z" fill="currentColor"/>
<path d="M91.1766 109.714V42.4371L106.857 19.5559V109.714H91.1766Z" fill="currentColor"/>
</svg>""",
        "models": [
            {"id": "x-ai/grok-4.1-fast", "name": "Grok 4.1 Fast", "cost_input": 2, "cost_output": 10},
            {"id": "x-ai/grok-4-fast", "name": "Grok 4 Fast", "cost_input": 2, "cost_output": 10},
            {"id": "x-ai/grok-4", "name": "Grok 4", "cost_input": 2, "cost_output": 10},
            {"id": "x-ai/grok-3", "name": "Grok 3", "cost_input": 2, "cost_output": 10},
            {"id": "x-ai/grok-code-fast-1", "name": "Grok Code Fast", "cost_input": 2, "cost_output": 10},
        ]
    },
    {
        "name": "DeepSeek",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path d="M123.756 27.1541C122.505 26.5294 121.967 27.7199 121.236 28.3243C120.986 28.5193 120.774 28.7726 120.563 29.0064C118.734 30.9963 116.598 32.3035 113.808 32.1473C109.729 31.9135 106.246 33.2204 103.167 36.3999C102.513 32.479 100.339 30.1371 97.0293 28.6359C95.2974 27.8557 93.5465 27.0748 92.334 25.3777C91.4874 24.1687 91.2564 22.8223 90.8332 21.4957C90.564 20.6964 90.2939 19.8767 89.3896 19.7397C88.4083 19.5836 88.0229 20.4221 87.6387 21.1252C86.0991 23.9931 85.5027 27.1532 85.5608 30.3521C85.6959 37.5512 88.6781 43.2858 94.605 47.3637C95.2784 47.832 95.4512 48.3 95.2402 48.9828C94.836 50.3877 94.3549 51.7529 93.9317 53.1578C93.6622 54.0553 93.2574 54.2503 92.3149 53.8603C89.0632 52.4757 86.2532 50.4266 83.7708 47.9496C79.5566 43.7939 75.747 39.2095 70.9938 35.6196C69.8939 34.7906 68.7642 34.0032 67.6071 33.2592C62.758 28.4603 68.2423 24.5191 69.5121 24.0514C70.8397 23.5633 69.9741 21.886 65.6824 21.9054C61.3913 21.9249 57.4657 23.3878 52.4631 25.3388C51.7316 25.6319 50.9623 25.8463 50.173 26.0212C45.6318 25.1432 40.9174 24.9482 35.9911 25.5137C26.7159 26.5667 19.3082 31.0345 13.8626 38.6624C7.32048 47.833 5.7806 58.2498 7.66653 69.1162C9.64843 80.5671 15.3825 90.0486 24.1957 97.4621C33.3359 105.147 43.8618 108.913 55.8686 108.191C63.1613 107.762 71.2821 106.768 80.4413 98.8661C82.7505 100.036 85.1747 100.505 89.1967 100.856C92.2949 101.149 95.2774 100.7 97.5866 100.213C101.204 99.4326 100.954 96.0183 99.6454 95.3945C89.0435 90.3618 91.3708 92.41 89.2545 90.7517C93.943 85.0987 100.701 79.2535 104.469 63.4192C105.372 59.6224 105.938 55.3802 105.938 51.4034C105.938 50.6068 106.111 50.2138 107.073 50.116C109.728 49.8034 112.307 49.063 114.674 47.7358C121.543 43.9121 124.314 37.6305 124.969 30.1004C125.065 28.9497 124.95 27.7585 123.756 27.1541ZM63.8934 94.9249C53.6175 86.6932 48.634 83.9808 46.5752 84.098C44.6511 84.2153 44.9972 86.4588 45.4205 87.9217C45.8628 89.3656 46.4408 90.3602 47.2486 91.6282C47.8066 92.4673 48.1917 93.7152 46.6909 94.6525C43.3814 96.7392 37.6276 93.95 37.3578 93.813C30.6616 89.7944 25.0619 84.4883 21.1169 77.2315C17.3072 70.2468 15.094 62.7565 14.7288 54.7578C14.6326 52.8268 15.1909 52.1431 17.0762 51.7927C19.5582 51.324 22.1175 51.2262 24.5999 51.5968C35.0868 53.1578 44.015 57.9373 51.5006 65.5063C55.7726 69.8171 59.0052 74.968 62.3348 80.0007C65.8753 85.3459 69.6853 90.4379 74.5344 94.6127C76.2471 96.0756 77.6129 97.1878 78.9218 98.0075C74.9767 98.4558 68.3955 98.5536 63.8934 94.9249ZM68.8635 62.2637C69.0263 61.5911 69.6203 61.0983 70.3396 61.0983C70.517 61.0987 70.6928 61.1317 70.8588 61.1955C71.0707 61.2738 71.263 61.3911 71.4171 61.566C71.6862 61.8396 71.8404 62.2296 71.8404 62.639C71.8404 63.4976 71.167 64.18 70.3205 64.18C69.9632 64.1834 69.6166 64.0552 69.3446 63.8191C69.0725 63.5831 68.8931 63.2549 68.8394 62.8948C68.8061 62.6849 68.8143 62.4703 68.8635 62.2637ZM83.6208 70.8385C82.8061 71.1558 81.9953 71.4049 81.2116 71.4374C79.7489 71.5151 78.1521 70.9105 77.2865 70.1691C75.9398 69.0184 74.9776 68.3751 74.5735 66.3649C74.4003 65.5063 74.4962 64.18 74.6504 63.4192C74.9967 61.7804 74.6116 60.7268 73.4768 59.7711C72.5534 58.9908 71.379 58.7764 70.0901 58.7764C69.609 58.7764 69.1667 58.562 68.8394 58.3865C68.3005 58.1138 67.8581 57.4307 68.2814 56.5916C68.4164 56.3189 69.0707 55.6552 69.2248 55.5386C70.9754 54.5239 72.9964 54.8556 74.8623 55.6164C76.5941 56.3383 77.903 57.6646 79.7886 59.5372C81.7127 61.7998 82.059 62.4246 83.1563 64.1217C84.0225 65.448 84.8112 66.8141 85.3501 68.3742C85.6243 69.1901 85.3723 69.8843 84.6183 70.374C84.3116 70.5731 83.959 70.7066 83.6208 70.8385Z" fill="currentColor"/>
</svg>""",
        "models": [
            {"id": "deepseek/deepseek-v3.2", "name": "DeepSeek V3.2", "cost_input": 0.14, "cost_output": 0.28},
            {"id": "deepseek/deepseek-chat-v3-0324", "name": "DeepSeek V3", "cost_input": 0.14, "cost_output": 0.28},
            {"id": "tngtech/deepseek-r1t2-chimera:free", "name": "DeepSeek R1", "cost_input": 0.14, "cost_output": 0.28},
            {"id": "deepseek/deepseek-chat-v3.1", "name": "DeepSeek 3.1", "cost_input": 0.14, "cost_output": 0.28},
            {"id": "nex-agi/deepseek-v3.1-nex-n1:free", "name": "DeepSeek V3.1 Nex", "cost_input": 0.14, "cost_output": 0.28},
        ]
    },
    {
        "name": "Perplexity",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M31.1108 11.1826L61.5503 39.5752V12.0005H66.264V39.5745L96.7031 11.1827V42.6396L109.386 42.6397V87.9387H96.7031V116.207L66.264 89.0656V116H61.5503V89.0655L31.1109 116.207V87.9388H18.6138V42.6397L31.1108 42.6396V11.1826ZM57.8616 47.3531L23.3275 47.3534V83.2251H31.1054L31.1114 71.9509L57.8616 47.3531ZM35.8246 74.0206V105.689L61.5503 82.7501L61.55 50.3652L35.8246 74.0206ZM66.264 82.7501V50.3655L91.9894 74.0206V105.689L66.264 82.7501ZM96.7031 83.225H104.672V47.3534L69.9519 47.3531L96.7031 71.9514V83.225ZM69.8889 42.6393L91.9894 22.0253V42.6394L69.8889 42.6393ZM57.9247 42.6393L35.8245 22.0253V42.6393H57.9247Z" fill="currentColor"/>
</svg>""",
        "models": [
            {"id": "perplexity/sonar-deep-research", "name": "Sonar Deep Research", "cost_input": 1, "cost_output": 5},
            {"id": "perplexity/sonar", "name": "Sonar", "cost_input": 1, "cost_output": 5},
            {"id": "perplexity/sonar-pro-search", "name": "Sonar Reasoning Pro", "cost_input": 1, "cost_output": 5},
            {"id": "perplexity/sonar-reasoning-pro", "name": "Sonar Pro Search", "cost_input": 1, "cost_output": 5},
        ]
    },
    {
        "name": "Moonshot",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 135 135" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_10025_222)"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.91749 95.1524L59.5744 109.507C59.5022 113.322 59.6148 117.139 59.9119 120.943L93.4144 129.904C83.4777 134.005 72.7049 135.673 61.9931 134.769L60.9806 134.679L60.7331 134.657L59.7319 134.55C59.4372 134.514 59.1429 134.477 58.8487 134.437L58.2469 134.359L57.6281 134.269C57.0268 134.181 56.4268 134.086 55.8281 133.982L55.5919 133.937L55.17 133.864L54.5681 133.751L54.1744 133.667L53.6512 133.56L53.2294 133.47L52.695 133.357L52.1494 133.228L51.6206 133.104L50.7431 132.885L50.2369 132.75L49.7025 132.609L49.2412 132.48L48.6281 132.311L48.2794 132.199L47.8069 132.058L47.2837 131.901L46.6931 131.709L46.3669 131.602L45.9169 131.456L45.4106 131.282L45.0394 131.147C44.9568 131.119 44.8743 131.091 44.7919 131.062L44.4094 130.922L43.8412 130.714L43.5206 130.59L43.0706 130.421L42.5812 130.224L42.0862 130.027L41.6419 129.847L41.1075 129.622L40.7531 129.465L40.3987 129.313C40.3217 129.28 40.2449 129.246 40.1681 129.212L39.7969 129.043L39.2175 128.779L38.925 128.644L38.385 128.385L38.0362 128.216L37.5637 127.991L37.08 127.744L36.5569 127.479L36.2644 127.327L35.685 127.018L35.3644 126.849L35.0381 126.669C34.9517 126.621 34.8654 126.572 34.7794 126.523L34.2506 126.225L33.9131 126.034L33.6262 125.865L33.2212 125.634L32.76 125.353L32.2369 125.038L31.9444 124.858L31.4719 124.56L31.1287 124.341L30.6844 124.059L30.2906 123.795L29.9925 123.598C29.891 123.531 29.7897 123.463 29.6887 123.396L29.1937 123.058C29.1185 123.006 29.0435 122.953 28.9687 122.901L28.6481 122.676L28.2206 122.372L27.8325 122.091L27.4162 121.787L26.6737 121.23L26.2462 120.898L25.5094 120.324L25.1494 120.032L24.7331 119.694L24.2325 119.284L23.715 118.845C23.6341 118.776 23.5535 118.706 23.4731 118.637L23.22 118.412L22.8769 118.114L22.4831 117.765L22.1006 117.427L21.7519 117.101L21.375 116.752L21.0769 116.471L20.5819 115.999C20.3953 115.818 20.2097 115.636 20.025 115.453L19.8619 115.296L19.6312 115.059L19.2431 114.666L18.9619 114.379L18.6806 114.081C18.3593 113.751 18.0442 113.415 17.7356 113.074L17.2856 112.579L16.5375 111.735L16.3012 111.459L16.0031 111.111L15.6769 110.728L15.4181 110.413C15.3673 110.351 15.3167 110.289 15.2662 110.227L15.0131 109.918L14.6419 109.457L14.4112 109.164L14.13 108.804L14.0175 108.664C10.799 104.492 8.08043 99.9571 5.91749 95.1524ZM0.179991 62.5611L64.0406 79.6443C62.9715 83.3681 62.091 87.1435 61.4025 90.9561L122.248 107.235C119.225 111.374 115.744 115.157 111.87 118.513L3.69562 89.5668L3.60562 89.308L3.40874 88.723C3.31306 88.4368 3.21931 88.1499 3.12749 87.8624L3.08812 87.733C2.65515 86.3566 2.26682 84.9665 1.92374 83.5649L1.75499 82.8561L1.65374 82.4061L1.53562 81.8605L1.43437 81.4049L1.33312 80.8986L1.23749 80.4261L1.13624 79.8974C0.989991 79.1043 0.854991 78.3055 0.736866 77.5011L0.641241 76.8374L0.579366 76.3705L0.506241 75.7968C0.468579 75.4951 0.432953 75.1933 0.399366 74.8911L0.371241 74.6268C-0.0490243 70.6184 -0.113025 66.5808 0.179991 62.5611ZM9.14062 33.5924L76.3481 51.5699C74.2781 54.973 72.3825 58.4943 70.6669 62.1168L134.201 79.1155C133.402 83.728 132.131 88.183 130.444 92.4186L0.697491 57.7124L0.781866 57.1499L0.826866 56.8743L0.883116 56.4974L0.967491 56.008L1.06874 55.4568C1.21499 54.6243 1.38374 53.7974 1.56374 52.9705L1.72124 52.273L1.83374 51.7949L1.96874 51.2493C2.09249 50.743 2.22187 50.2368 2.36249 49.7418L2.51999 49.168L2.64937 48.7011L2.81812 48.1386L2.95874 47.6774L3.12749 47.1374L3.27374 46.6761L3.44812 46.1418C4.90474 41.7724 6.80858 37.5651 9.12937 33.5868L9.14062 33.5924ZM34.1269 8.84239L97.605 25.8186C94.2552 28.859 91.0849 32.0913 88.11 35.4993L132.114 47.2724C133.616 52.0649 134.601 57.0824 135 62.263L11.8462 29.323L12.0994 28.9574L12.2512 28.7324L12.4762 28.423L12.735 28.0574L13.0444 27.6299L13.3481 27.2249L13.7081 26.7411L13.9894 26.3755L14.31 25.9649L14.6194 25.5711L14.9569 25.1549L15.2662 24.7668L15.6319 24.3336L15.9356 23.9624L16.3069 23.5293L16.605 23.1918L17.01 22.7305L17.3081 22.393L17.685 21.9768L17.9887 21.6505L18.3994 21.2118L18.7256 20.8743L19.08 20.4974L20.025 19.5411L20.5875 18.9899L20.9194 18.6749L21.3469 18.2755C25.2236 14.6425 29.5128 11.4765 34.1269 8.84239ZM67.5956 -0.000112304H68.1412L68.6025 0.0055127L68.9906 0.0111377L69.2944 0.0223877L69.6769 0.0336377L69.9356 0.0392627L70.3631 0.0561377L70.6275 0.0673877L70.965 0.0842627L71.2687 0.0955127L71.7581 0.123638L72.3487 0.163013L73.1587 0.224888L73.6537 0.264263L73.9012 0.286763L74.3344 0.331763L74.7956 0.376763L75.06 0.404888L75.6337 0.472388L75.915 0.506138L76.5225 0.584888L76.9781 0.641138L77.2144 0.674888L78.7444 0.911138L79.1381 0.978638L79.5037 1.04051L80.2912 1.18676L80.8087 1.28801L81.4275 1.41176L81.6862 1.46801L82.1081 1.55801L82.3387 1.61426L82.6875 1.68739L82.9237 1.74364L83.2894 1.82801L83.565 1.89551L83.9644 1.99114L84.5044 2.12614L85.1344 2.29489L85.77 2.46364L86.4056 2.64364L86.6869 2.72801L87.0806 2.84051L87.5194 2.97551L87.93 3.10489L88.4925 3.28489L88.92 3.42551L89.4769 3.61114L90.0506 3.81364L90.3206 3.90926L90.6806 4.03864L91.2037 4.22989L91.8225 4.46051L92.475 4.71364L93.0375 4.93864L93.3019 5.05114L93.6394 5.18614L93.87 5.28739L94.2244 5.43364L94.4494 5.53489L94.77 5.67551L95.3887 5.94551L95.9512 6.20426L96.3675 6.40114L96.7894 6.60364L97.1269 6.76114L97.6444 7.01989L98.1562 7.27301L98.73 7.56551L99.0281 7.72301L99.3037 7.86926L99.5625 8.00426L99.9 8.18989L100.131 8.31364L100.423 8.47676L100.918 8.75801L101.514 9.09551L102.004 9.38239L102.324 9.57364L102.622 9.75364L103.162 10.0855L103.657 10.3949L104.209 10.7436L104.411 10.8786L104.771 11.1093L105.244 11.4243L105.469 11.5761L105.817 11.8124L106.166 12.0543L106.296 12.1499C106.599 12.358 106.903 12.5718 107.201 12.7911L107.668 13.1286L108.034 13.3986L108.349 13.6405L108.832 14.0061L109.294 14.3661L109.519 14.5349L109.8 14.7655L110.284 15.1536L110.728 15.5193L111.206 15.9186C115.211 19.2936 118.817 23.1355 121.944 27.343L40.6237 5.59114L40.9725 5.43926L41.3381 5.28176L41.7937 5.09051L42.2775 4.89364C42.9131 4.64051 43.5544 4.38739 44.1956 4.15676L44.7356 3.95989L45.2587 3.77426L45.7312 3.60551L46.2712 3.43114C46.7606 3.26239 47.2612 3.10489 47.7562 2.95301L48.2681 2.80114L48.7519 2.66051L49.3256 2.49176L49.8037 2.36239L50.3662 2.21614L50.85 2.08114L51.3562 1.95176L51.8681 1.82801L52.4025 1.70426L52.9087 1.59176L53.46 1.47364L53.9719 1.36114L54.5062 1.25989L55.0237 1.15864L55.5862 1.05739L56.0981 0.967388L56.6494 0.871763L57.1669 0.793013L57.7125 0.708638L58.23 0.635513L58.8037 0.562388L59.3156 0.494888L59.9062 0.427388L60.4125 0.371138L61.0031 0.314888C61.5262 0.258638 62.0494 0.213638 62.5781 0.179888L63.1744 0.134888L63.6806 0.106763L64.2994 0.0730127L64.8225 0.0505127L65.385 0.0280127L66.4875 0.0055127L67.5956 -0.0057373V-0.000112304Z" fill="currentColor"/></g><defs><clipPath id="clip0_10025_222"><rect width="100%" height="100%" fill="currentColor"/></clipPath></defs></svg>""",
        "models": [
            {"id": "moonshotai/kimi-k2-0905", "name": "Kimi k2", "cost_input": 1, "cost_output": 5},
            {"id": "moonshotai/kimi-k2-thinking", "name": "Kimi k2 Thinking", "cost_input": 1, "cost_output": 5},
            {"id": "moonshotai/kimi-k2:free", "name": "Kimi k2 Free", "cost_input": 1, "cost_output": 5},
        ]
    },
    {
        "name": "Mistral",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_8036_2021)">
<path d="M125.948 90.4036H72.8252V108.002H125.948V90.4036Z" fill="currentColor"/>
<path d="M55.1228 90.4036H2V108.002H55.1228V90.4036Z" fill="currentColor"/>
<path d="M108.232 72.7951H90.5284V90.393H108.232V72.7951Z" fill="currentColor"/>
<path d="M72.8197 72.7951H55.1158V90.393H72.8197V72.7951Z" fill="currentColor"/>
<path d="M37.4072 72.7951H19.7034V90.393H37.4072V72.7951Z" fill="currentColor"/>
<path d="M108.232 20H90.5284V37.5978H108.232V20Z" fill="currentColor"/>
<path d="M108.233 37.5964H72.8252V55.1942H108.233V37.5964Z" fill="currentColor"/>
<path d="M37.4072 20H19.7034V37.5978H37.4072V20Z" fill="currentColor"/>
<path d="M55.1114 37.5964H19.7034V55.1942H55.1114V37.5964Z" fill="currentColor"/>
<path d="M108.234 55.193H19.7034V72.7906H108.234V55.193Z" fill="currentColor"/>
</g>
<defs>
<clipPath id="clip0_8036_2021">
<rect width="100%" height="100%" fill="currentColor" transform="translate(2 20)"/>
</clipPath>
</defs>
</svg>""",
        "models": [
            {"id": "mistralai/mistral-small-3.2-24b-instruct", "name": "Mistral Small 3.2 24B", "cost_input": 0.14, "cost_output": 0.28},
            {"id": "mistralai/mistral-nemo", "name": "Mistral Nemo", "cost_input": 0.14, "cost_output": 0.28},
            {"id": "cognitivecomputations/dolphin-mistral-24b-venice-edition:free", "name": "Mistral 24B", "cost_input": 0.14, "cost_output": 0.28},
        ]
    },
    {
        "name": "Meta (LLaMA)",
        "icon": """<svg width="100%" height="100%" viewBox="0 0 128 128" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path d="M39.7598 26H39.6458L39.4985 38.4212H39.603C47.7493 38.4212 54.0715 44.867 67.818 68.0898L68.6493 69.5005L68.7063 69.5955L76.4013 58.015L76.3443 57.9247C74.6627 55.1717 72.9239 52.4541 71.1288 49.7738C69.3615 47.1286 67.4999 44.5477 65.5475 42.036C56.4608 30.427 48.8608 26 39.7598 26Z" fill="currentColor"/>
<path d="M39.6458 26C30.5115 26.0475 22.4221 31.9755 16.5939 41.0575C16.578 41.0844 16.5622 41.1113 16.5464 41.1382L27.2529 46.9855L27.3051 46.9048C30.7156 41.7605 34.9526 38.4783 39.5031 38.426H39.6029L39.7549 26H39.6458Z" fill="currentColor"/>
<path d="M16.5905 41.0574L16.5382 41.1382C12.7002 47.1232 9.8407 54.4762 8.3017 62.4039L8.27795 62.5084L20.3145 65.3584L20.3335 65.2539C21.616 58.2857 24.067 51.8209 27.2495 46.9902L27.3017 46.9094L16.5905 41.0574Z" fill="currentColor"/>
<path d="M20.3335 65.2539L8.3017 62.4039L8.27795 62.5084C7.4372 66.8689 7.0095 71.3008 7 75.742V75.8513L19.3405 76.958V76.8488C19.2956 72.9622 19.6297 69.0805 20.338 65.2588L20.3335 65.2539Z" fill="currentColor"/>
<path d="M19.7163 80.8008C19.495 79.5248 19.3696 78.2339 19.3411 76.9391V76.8346L7.00058 75.7231V75.8371C6.98674 78.4686 7.21891 81.0957 7.69408 83.6841L19.7353 80.9053C19.7289 80.8705 19.7226 80.8357 19.7163 80.8008Z" fill="currentColor"/>
<path d="M22.5329 87.2276C21.1839 85.7551 20.2339 83.6366 19.7352 80.9196L19.7162 80.8198L7.67493 83.5986L7.69393 83.6983C8.60593 88.4958 10.3919 92.4858 12.9474 95.5116L13.0139 95.5923L22.5994 87.3036C22.5755 87.2784 22.5565 87.253 22.5329 87.2276Z" fill="currentColor"/>
<path d="M58.2048 52.8565C50.9468 64.019 46.5483 71.0252 46.5483 71.0252C36.882 86.2252 33.538 89.631 28.161 89.631C27.1036 89.6585 26.0527 89.4571 25.0803 89.0407C24.108 88.6242 23.2372 88.0024 22.5275 87.218L12.9468 95.502L13.0133 95.5827C16.5473 99.7105 21.5253 102 27.6908 102C37.015 102 43.7173 97.592 55.6398 76.6825L64.0283 61.815C62.1673 58.7764 60.2286 55.7891 58.2048 52.8565Z" fill="currentColor"/>
<path d="M71.1353 35.2435L71.0593 35.3195C69.1593 37.362 67.3258 39.6325 65.5493 42.0455C67.3448 44.3398 69.1973 46.9095 71.1306 49.788C73.4106 46.2588 75.5386 43.3993 77.6238 41.2048L77.6998 41.1288L71.1353 35.2435Z" fill="currentColor"/>
<path d="M106.36 34.1367C101.301 29.0067 95.2685 26 88.818 26C82.016 26 76.2922 29.7382 71.1337 35.234L71.0577 35.31L77.6222 41.2L77.6982 41.1193C81.0945 37.571 84.3862 35.7993 88.0342 35.7993C91.9577 35.7993 95.6342 37.6518 98.8167 40.9055L98.888 40.9815L106.436 34.2128L106.36 34.1367Z" fill="currentColor"/>
<path d="M120.991 74.0938C120.706 57.6256 114.958 42.9053 106.437 34.2128L106.361 34.1368L98.8179 40.9008L98.8891 40.9768C105.302 47.5888 109.705 59.8818 110.104 74.0891V74.1983H120.991V74.0938Z" fill="currentColor"/>
<path d="M120.991 74.2126V74.1033H110.104V74.2078C110.123 74.8728 110.132 75.5473 110.132 76.2218C110.132 80.0931 109.557 83.2233 108.384 85.4843L108.332 85.5888L116.445 94.0533L116.507 93.9583C119.452 89.3983 121 83.0666 121 75.3858C121 74.9916 121 74.6021 120.991 74.2126Z" fill="currentColor"/>
<path d="M108.384 85.4701L108.332 85.5651C107.315 87.4746 105.867 88.7476 103.976 89.3033L107.672 100.998C108.384 100.757 109.079 100.468 109.752 100.133C112.382 98.8036 114.619 96.8091 116.241 94.3478L116.45 94.0391L116.507 93.9441L108.384 85.4701Z" fill="currentColor"/>
<path d="M101.619 89.6167C100.375 89.6167 99.2821 89.4315 98.2086 88.9517L94.4181 100.931C96.5508 101.658 98.8213 101.986 101.353 101.986C103.69 101.986 105.832 101.639 107.775 100.964L104.07 89.27C103.277 89.5075 102.455 89.6262 101.619 89.6167Z" fill="currentColor"/>
<path d="M94.0349 85.5366L93.9684 85.4559L85.2474 94.5474L85.3234 94.6281C88.3492 97.8676 91.2419 99.8769 94.5242 100.979L98.3099 89.0089C96.9277 88.4151 95.5882 87.3321 94.0349 85.5366Z" fill="currentColor"/>
<path d="M93.9678 85.4462C91.3553 82.3967 88.1158 77.3142 83.0285 69.1062L76.3975 58.0102L76.3453 57.9152L68.6503 69.4957L68.7073 69.5907L73.405 77.5137C77.9603 85.1612 81.67 90.6902 85.2468 94.5425L85.3228 94.6185L94.0343 85.527C94.012 85.5002 93.9898 85.4732 93.9678 85.4462Z" fill="currentColor"/>
</svg>""",
        "models": [
            {"id": "meta-llama/llama-4-maverick", "name": "Llama 4 Maverick", "cost_input": 1, "cost_output": 5},
            {"id": "meta-llama/llama-4-scout", "name": "Llama 4 Scout", "cost_input": 1, "cost_output": 5},
            {"id": "meta-llama/llama-3.3-70b-instruct:free", "name": "Llama 3.3 70B", "cost_input": 1, "cost_output": 5},
        ]
    },
    {
        "name": "Медиа (Видео/Фото)",
        "icon": """<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm0 2v12h16V6H4zm3 3a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm10 8H7v-1l4-4 2 2 3-3 3 3v3z" fill="currentColor"/></svg>""",
        "models": [
            {"id": "fal-ai/kling-video/v1.5/pro", "name": "Kling 1.5", "cost_input": 0, "cost_output": 90},
            {"id": "fal-ai/luma-dream-machine", "name": "Luma Ray", "cost_input": 0, "cost_output": 45},
            {"id": "fal-ai/runway-gen3/turbo/image-to-video", "name": "Runway Gen3", "cost_input": 0, "cost_output": 40},
            {"id": "fal-ai/minimax/video-01", "name": "Minimax", "cost_input": 0, "cost_output": 70},
            {"id": "fal-ai/hailuo/video", "name": "Hailuo", "cost_input": 0, "cost_output": 60},
            {"id": "fal-ai/flux-pro/v1.1-ultra", "name": "Flux Pro", "cost_input": 0, "cost_output": 6},
            {"id": "fal-ai/flux-realism", "name": "Flux Realism", "cost_input": 0, "cost_output": 5},
            {"id": "fal-ai/recraft-v3", "name": "Recraft V3", "cost_input": 0, "cost_output": 8},
            {"id": "fal-ai/ideogram/v2", "name": "Ideogram", "cost_input": 0, "cost_output": 12},
            {"id": "fal-ai/midjourney-v6", "name": "Midjourney", "cost_input": 0, "cost_output": 15},
        ]
    }
]

# Генерируем словарь цен для быстрого доступа по ID модели
MODEL_PRICING = {}
for group in AI_MODELS_GROUPS:
    for m in group['models']:
        MODEL_PRICING[m['id']] = {
            "input": m.get("cost_input", 0),
            "output": m.get("cost_output", 0)
        }

def get_models_config():
    """Возвращает полный конфиг моделей для API"""
    return AI_MODELS_GROUPS

# ==============================================================================

async def generate_ai_response_stream(model_id: str, messages: list, user_balance: float, temperature: float = 0.7, web_search: bool = False, attachment_url: str = None):
    # Пытаемся найти модель в прайсинге
    pricing = MODEL_PRICING.get(model_id)
    if not pricing:
        # Fallback
        pricing = {"input": 0, "output": 0}
        logger.warning(f"Model ID {model_id} not found in pricing config.")
    
    # Подготовка сообщений (Vision)
    final_messages = []
    for msg in messages:
        content = msg["content"]
        role = msg["role"]
        
        # Если есть картинка в ПОСЛЕДНЕМ сообщении пользователя
        if role == "user" and attachment_url and msg == messages[-1]:
            content_block = [{"type": "text", "text": content}]
            content_block.append({
                "type": "image_url",
                "image_url": {"url": attachment_url}
            })
            final_messages.append({"role": role, "content": content_block})
        else:
            final_messages.append({"role": role, "content": content})

    # Параметры OpenRouter
    extra_body = {}
    if web_search:
        extra_body["plugins"] = [{"id": "web_search"}] 

    try:
        stream = await client.chat.completions.create(
            model=model_id,
            messages=final_messages,
            temperature=temperature,
            stream=True,
            extra_body=extra_body
        )

        full_response = ""
        input_tokens_approx = sum(len(m['content']) for m in messages) / 4 
        
        async for chunk in stream:
            content = chunk.choices[0].delta.content
            if content:
                full_response += content
                yield content, 0.0

        # Финальный подсчет стоимости
        output_tokens = len(full_response) / 4
        total_cost = (input_tokens_approx / 1_000_000 * pricing['input']) + \
                     (output_tokens / 1_000_000 * pricing['output'])
        
        yield "", total_cost

    except Exception as e:
        logger.error(f"AI Generation Error: {e}")
        yield f"Error: {str(e)}", 0.0


async def generate_ai_response_media(model_id: str, messages: list, user_balance: float, attachment_url: str = None):
    """
    Генерация для медиа-моделей через Fal.ai.
    """
    prompt = messages[-1]['content']
    pricing = MODEL_PRICING.get(model_id, {"input": 0, "output": 0})
    cost = pricing['output']

    if user_balance < cost:
        raise Exception("Недостаточно средств")

    try:
        # Здесь должна быть реальная интеграция с API генерации картинок
        # (вставь сюда код вызова Fal.ai из своего бэкапа, если он был)
        
        # Эмуляция (задержка для реализма)
        import asyncio
        await asyncio.sleep(2)
        return f"![Generated Image](https://via.placeholder.com/1024x1024?text=Gen+{model_id.split('/')[-1]}) (Генерация {model_id})", cost

    except Exception as e:
        logger.error(f"Media Gen Error: {e}")
        raise e