<aside 
    class="flex flex-col w-72 h-full bg-bg-secondary border-r border-border z-40 transition-transform duration-300 absolute md:relative"
    :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
    x-cloak
>
    <div class="p-4 flex items-center justify-between h-[var(--header-height)]">
        <a href="/" class="flex items-center gap-2 font-bold text-xl tracking-tight text-text-primary">
            <img src="/static/media/logo-desktop.svg" alt="Logo" class="h-10 w-auto">
        </a>
        <button @click="sidebarOpen = false" class="md:hidden text-text-secondary hover:text-text-primary transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>

    <div class="px-4 mb-4 space-y-3">
        <button @click="startNewChat ? startNewChat() : window.location.href='/'" 
                class="w-full flex items-center gap-3 px-4 py-3 bg-bg-elevated hover:bg-bg-hover rounded-xl transition-colors border border-border text-sm font-medium text-text-primary">
            <i class="ph ph-plus text-lg"></i>
            <span>–ù–æ–≤—ã–π —á–∞—Ç</span>
        </button>

        <div class="relative" x-show="typeof chatSearch !== 'undefined'">
            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-text-muted"></i>
            <input type="text" 
                   x-model="chatSearch" 
                   placeholder="–ü–æ–∏—Å–∫..." 
                   class="w-full bg-bg-tertiary border border-border rounded-lg pl-9 pr-3 py-2 text-sm text-text-primary placeholder-text-muted focus:outline-none focus:border-primary transition">
        </div>
    </div>

    <div class="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar">
        <template x-if="typeof filteredChats !== 'undefined' && filteredChats.length > 0">
            <div>
                <div class="px-4 py-2 text-xs font-semibold text-text-muted uppercase tracking-wider">–ò—Å—Ç–æ—Ä–∏—è</div>
                <template x-for="chat in filteredChats" :key="chat.id">
                    <div class="group relative" x-data="{ editing: false, editTitle: '' }">
                        <div x-show="editing" class="px-3 py-2">
                            <input type="text" x-model="editTitle" 
                                   @keydown.enter="renameChat(chat.id, editTitle); editing = false"
                                   @keydown.escape="editing = false"
                                   @blur="editing = false"
                                   x-init="editTitle = chat.title"
                                   class="w-full bg-bg-tertiary border border-primary rounded-lg px-2 py-1.5 text-sm text-text-primary focus:outline-none">
                        </div>
                        <button x-show="!editing" 
                                @click="loadChat ? loadChat(chat.id) : null" 
                                @dblclick.stop="if(renameChat) { editing = true; editTitle = chat.title; $nextTick(() => $el.previousElementSibling.querySelector('input').focus()) }" 
                                class="w-full text-left flex items-center gap-3 px-3 py-3 rounded-lg transition-colors" 
                                :class="(typeof activeChatId !== 'undefined' && activeChatId === chat.id) ? 'bg-bg-elevated text-text-primary' : 'text-text-secondary hover:bg-bg-hover hover:text-text-primary'">
                            <i class="ph ph-chat-circle text-lg"></i>
                            <div class="flex-1 truncate text-sm" x-text="chat.title"></div>
                        </button>
                        <button x-show="!editing && typeof deleteChat !== 'undefined'" 
                                @click.stop="deleteChat(chat.id)" 
                                class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-text-muted hover:text-danger hover:bg-danger/10 rounded-lg opacity-0 group-hover:opacity-100 transition-all">
                            <i class="ph ph-trash text-sm"></i>
                        </button>
                    </div>
                </template>
            </div>
        </template>
        
        <div x-show="typeof filteredChats === 'undefined' || filteredChats.length === 0" class="px-2 mt-4">
             <a href="/profile" class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-secondary hover:bg-bg-hover hover:text-text-primary transition-colors">
                <i class="ph ph-user text-lg"></i>
                <span class="text-sm">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
             </a>
             <a href="/logout" class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-secondary hover:bg-bg-hover hover:text-danger transition-colors">
                <i class="ph ph-sign-out text-lg"></i>
                <span class="text-sm">–í—ã–π—Ç–∏</span>
             </a>
        </div>
    </div>

    <div class="p-4 border-t border-border bg-bg-secondary">
        <div class="flex items-center justify-between mb-3">
             <button onclick="toggleTheme()" class="text-text-muted hover:text-text-primary transition-colors p-1" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                <i class="ph ph-moon block dark:hidden"></i>
                <i class="ph ph-sun hidden dark:block"></i>
             </button>
             <div class="text-xs text-primary font-bold px-2 py-1 bg-primary/10 rounded-md border border-primary/20">
                 {{ balance }} ‚ÇΩ
             </div>
        </div>

        <a href="/profile" class="flex items-center gap-3 p-2 rounded-xl hover:bg-bg-hover transition-colors cursor-pointer group">
            {% if avatar %}
                <img src="{{ avatar }}" class="w-9 h-9 rounded-full object-cover border border-border">
            {% else %}
                <div class="w-9 h-9 rounded-full bg-bg-elevated flex items-center justify-center text-text-secondary border border-border">üë§</div>
            {% endif %}
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-text-primary truncate">{{ name }}</div>
                <div class="text-xs text-text-muted truncate">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            <i class="ph ph-gear text-text-muted group-hover:text-text-primary transition-colors"></i>
        </a>
    </div>
</aside>