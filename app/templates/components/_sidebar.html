<aside 
    class="flex flex-col h-full bg-bg-secondary border-r border-border z-40 transition-all duration-300 absolute md:relative"
    :class="[
        sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0',
        sidebarCollapsed ? 'w-20' : 'w-80'
    ]"
    x-data="{ currentTheme: localStorage.getItem('theme') || 'dark' }"
    x-cloak
>
    {# === HEADER (–õ–æ–≥–æ + –ö–Ω–æ–ø–∫–∞) === #}
    <div class="flex items-center h-[var(--header-height)] px-4 flex-shrink-0"
         :class="sidebarCollapsed ? 'justify-center' : 'justify-between'">
        
        {# –õ–æ–≥–æ—Ç–∏–ø (–í–∏–¥–µ–Ω –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ) #}
        <a href="/" class="flex items-center gap-2 font-bold text-xl tracking-tight text-text-primary overflow-hidden whitespace-nowrap transition-opacity duration-200"
           x-show="!sidebarCollapsed">
            <img src="/static/media/logo-desktop.svg" alt="Logo" class="h-8 w-auto">
        </a>

        {# 1. –ö–Ω–æ–ø–∫–∞ –°–í–ï–†–ù–£–¢–¨ (–í–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –º–µ–Ω—é –û–¢–ö–†–´–¢–û) #}
        <button @click="toggleSidebarCollapse()" 
                class="flex p-1.5 text-text-primary bg-bg-tertiary rounded-lg border border-border hover:bg-bg-hover transition-colors"
                x-show="!sidebarCollapsed"
                title="–°–≤–µ—Ä–Ω—É—Ç—å">
            <i class="ph ph-caret-left text-lg"></i>
        </button>

        {# 2. –ö–Ω–æ–ø–∫–∞ –†–ê–ó–í–ï–†–ù–£–¢–¨ (–í–∏–¥–Ω–∞, –∫–æ–≥–¥–∞ –º–µ–Ω—é –°–í–ï–†–ù–£–¢–û) #}
        <button @click="toggleSidebarCollapse()" 
                x-show="sidebarCollapsed" 
                class="flex w-full justify-center py-2 text-text-primary hover:text-white transition-colors"
                title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
            <i class="ph ph-caret-right text-xl"></i>
        </button>

        {# –ö–Ω–æ–ø–∫–∞ –ó–ê–ö–†–´–¢–¨ (–¢–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –∫—Ä–µ—Å—Ç–∏–∫) #}
        <button @click="sidebarOpen = false" class="md:hidden text-text-secondary ml-auto">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
    
    {# === MAIN ACTIONS (–ù–æ–≤—ã–π —á–∞—Ç + –ü–æ–∏—Å–∫) === #}
    <div class="px-3 mb-4 space-y-3 flex-shrink-0">
        {# –ö–Ω–æ–ø–∫–∞ –ù–æ–≤—ã–π —á–∞—Ç #}
        <button @click="startNewChat ? startNewChat() : window.location.href='/'" 
                class="w-full flex items-center justify-center gap-3 px-3 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-xl transition-all shadow-lg shadow-primary-500/20 group relative overflow-hidden"
                :title="sidebarCollapsed ? '–ù–æ–≤—ã–π —á–∞—Ç' : ''">
            <i class="ph ph-plus text-lg"></i>
            <span class="font-medium whitespace-nowrap" x-show="!sidebarCollapsed">–ù–æ–≤—ã–π —á–∞—Ç</span>
        </button>

        {# –ü–æ–∏—Å–∫ (–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π) #}
        <div class="relative" x-show="!sidebarCollapsed && typeof chatSearch !== 'undefined'">
            <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-text-muted"></i>
            <input type="text" 
                   x-model="chatSearch" 
                   placeholder="–ü–æ–∏—Å–∫..." 
                   class="w-full bg-bg-tertiary border border-border rounded-lg pl-9 pr-3 py-2 text-sm text-text-primary placeholder-text-muted focus:outline-none focus:border-primary transition">
        </div>
        
        {# –ü–æ–∏—Å–∫ (–°–≤–µ—Ä–Ω—É—Ç—ã–π - –∏–∫–æ–Ω–∫–∞) #}
        <button @click="toggleSidebarCollapse(); $nextTick(() => $el.parentElement.querySelector('input').focus())" 
                x-show="sidebarCollapsed" 
                class="w-full py-2 text-text-muted hover:text-text-primary flex justify-center"
                title="–ü–æ–∏—Å–∫">
            <i class="ph ph-magnifying-glass text-xl"></i>
        </button>
    </div>

    {# === –í–†–ï–ú–ï–ù–ù–´–ô –ß–ê–¢ === #}
    <div class="px-4 mb-2" x-show="!sidebarCollapsed">
        <div class="flex items-center justify-between p-3 rounded-xl border border-border bg-bg-tertiary/50 hover:bg-bg-tertiary transition-all cursor-pointer group" 
             @click="toggleTempChat()">
            
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors"
                     :class="isTempChat ? 'bg-primary/20 text-primary' : 'bg-bg-elevated text-text-muted'">
                    <i class="ph ph-clock-countdown text-lg"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-medium text-text-primary">–í—Ä–µ–º–µ–Ω–Ω—ã–π —á–∞—Ç</span>
                    <span class="text-[10px] text-text-muted" x-text="isTempChat ? '–£–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑ 24—á' : '–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è'"></span>
                </div>
            </div>

            <div class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200"
                 :class="isTempChat ? 'bg-primary' : 'bg-gray-600'">
                <span class="inline-block h-3 w-3 transform rounded-full bg-white transition duration-200 shadow-sm"
                      :class="isTempChat ? 'translate-x-5' : 'translate-x-1'"></span>
            </div>
        </div>
    </div>

    {# === –°–ü–ò–°–û–ö –ß–ê–¢–û–í === #}
    <div class="flex-1 overflow-y-auto px-2 space-y-1 custom-scrollbar">
        <template x-if="typeof filteredChats !== 'undefined' && filteredChats.length > 0">
            <div>
                <div class="px-4 py-2 flex items-center justify-between group" x-show="!sidebarCollapsed">
                    <div class="text-xs font-semibold text-text-muted uppercase tracking-wider">–ò—Å—Ç–æ—Ä–∏—è</div>
                    
                    <div class="relative" @click.outside="historyMenuOpen = false">
                        <button @click="historyMenuOpen = !historyMenuOpen" 
                                class="p-1 text-text-muted hover:text-danger rounded transition-colors opacity-0 group-hover:opacity-100" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">
                            <i class="ph ph-trash"></i>
                        </button>
                        
                        <div x-show="historyMenuOpen" 
                             class="absolute right-0 top-full mt-1 w-48 bg-bg-elevated border border-border rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col py-1"
                             x-transition.origin.top.right>
                            <button @click="deleteHistory('last_hour')" class="text-left px-4 py-2 text-sm hover:bg-bg-hover text-text-primary">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å</button>
                            <button @click="deleteHistory('last_24h')" class="text-left px-4 py-2 text-sm hover:bg-bg-hover text-text-primary">–ó–∞ 24 —á–∞—Å–∞</button>
                            <div class="h-px bg-border my-1"></div>
                            <button @click="deleteHistory('all')" class="text-left px-4 py-2 text-sm hover:bg-red-500/10 text-danger">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
                        </div>
                    </div>
                </div>

                <template x-for="chat in filteredChats" :key="chat.id">
                    <div class="group relative mb-1" x-data="{ menuOpen: false }">
                        
                        <div x-show="renamingChatId === chat.id" class="px-2 py-1" x-show="!sidebarCollapsed">
                            <input type="text" x-model="renameTitle" 
                                   @keydown.enter="submitRename()"
                                   @keydown.escape="renamingChatId = null"
                                   @blur="submitRename()"
                                   x-init="$nextTick(() => $el.focus())"
                                   class="w-full bg-bg-tertiary border border-primary rounded px-2 py-1 text-sm text-text-primary focus:outline-none">
                        </div>

                        <button x-show="renamingChatId !== chat.id"
                                @click="loadChat(chat.id)" 
                                class="w-full text-left flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all border border-transparent" 
                                :class="(activeChatId === chat.id) 
                                    ? 'bg-bg-elevated border-border shadow-sm text-text-primary' 
                                    : 'text-text-secondary hover:bg-bg-hover hover:text-text-primary'"
                                :title="sidebarCollapsed ? chat.title : ''">
                            
                            <i class="text-lg flex-shrink-0" 
                               :class="chat.is_pinned ? 'ph-fill ph-push-pin text-primary' : 'ph ph-chat-circle'"></i>
                            
                            <div class="flex-1 truncate text-sm" x-show="!sidebarCollapsed" x-text="chat.title"></div>
                            
                            <div class="relative" x-show="!sidebarCollapsed" @click.stop>
                                <button @click="menuOpen = !menuOpen; activeChatMenu = chat.id" 
                                        class="p-1 text-text-muted hover:text-text-primary rounded opacity-0 group-hover:opacity-100 transition-opacity"
                                        :class="menuOpen ? 'opacity-100' : ''">
                                    <i class="ph ph-dots-three-vertical"></i>
                                </button>

                                <div x-show="menuOpen" 
                                     @click.outside="menuOpen = false"
                                     class="absolute right-0 top-8 w-40 bg-bg-elevated border border-border rounded-xl shadow-xl z-50 py-1 flex flex-col"
                                     x-transition>
                                    
                                    <button @click="togglePinChat(chat.id); menuOpen = false" class="flex items-center gap-2 px-3 py-2 text-xs hover:bg-bg-hover text-text-primary">
                                        <i class="ph" :class="chat.is_pinned ? 'ph-push-pin-slash' : 'ph-push-pin'"></i>
                                        <span x-text="chat.is_pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å'"></span>
                                    </button>
                                    
                                    <button @click="shareChat(chat.id); menuOpen = false" class="flex items-center gap-2 px-3 py-2 text-xs hover:bg-bg-hover text-text-primary">
                                        <i class="ph ph-share-network"></i>
                                        <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                                    </button>
                                    
                                    <button @click="startRenaming(chat.id, chat.title); menuOpen = false" class="flex items-center gap-2 px-3 py-2 text-xs hover:bg-bg-hover text-text-primary">
                                        <i class="ph ph-pencil-simple"></i>
                                        <span>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</span>
                                    </button>
                                    
                                    <div class="h-px bg-border my-1"></div>
                                    
                                    <button @click="deleteChat(chat.id)" class="flex items-center gap-2 px-3 py-2 text-xs hover:bg-red-500/10 text-danger">
                                        <i class="ph ph-trash"></i>
                                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                                    </button>
                                </div>
                            </div>
                        </button>
                    </div>
                </template>
            </div>
        </template>
        
        <div x-show="typeof filteredChats === 'undefined' || filteredChats.length === 0" class="px-4 mt-8 text-center" x-show="!sidebarCollapsed">
             <div class="text-text-muted text-sm mb-4">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
        </div>
    </div>

    {# === FOOTER (–¢–µ–º–∞ –∏ –ü—Ä–æ—Ñ–∏–ª—å) === #}
    <div class="p-3 border-t border-border bg-bg-secondary flex-shrink-0 flex flex-col gap-1">
        
        {# 1. –ö–ù–û–ü–ö–ê –°–ú–ï–ù–´ –¢–ï–ú–´ #}
        <button @click="window.toggleTheme(); currentTheme = localStorage.getItem('theme')" 
                class="flex items-center gap-3 p-2 rounded-xl hover:bg-bg-hover transition-colors cursor-pointer group w-full text-text-secondary hover:text-text-primary"
                :title="currentTheme === 'dark' ? '–í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É' : '–í–∫–ª—é—á–∏—Ç—å —Ç–µ–º–Ω—É—é —Ç–µ–º—É'">
            
            <div class="w-9 h-9 rounded-full bg-bg-tertiary flex items-center justify-center border border-border group-hover:border-primary/50 transition-colors">
                 <i class="ph text-lg" :class="currentTheme === 'dark' ? 'ph-moon' : 'ph-sun'"></i>
            </div>
            
            <div class="flex-1 text-left text-sm font-medium" x-show="!sidebarCollapsed">
                <span x-text="currentTheme === 'dark' ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞'"></span>
            </div>
        </button>

        {# 2. –ü–†–û–§–ò–õ–¨ #}
        <a href="/profile" class="flex items-center gap-3 p-2 rounded-xl hover:bg-bg-hover transition-colors cursor-pointer group">
            {% if avatar %}
                <img src="{{ avatar }}" class="w-9 h-9 rounded-full object-cover border border-border">
            {% else %}
                <div class="w-9 h-9 rounded-full bg-bg-elevated flex items-center justify-center text-text-secondary border border-border">üë§</div>
            {% endif %}
            
            <div class="flex-1 min-w-0" x-show="!sidebarCollapsed">
                <div class="text-sm font-medium text-text-primary truncate">{{ name }}</div>
                <div class="text-xs text-primary font-bold">{{ balance }} ‚ÇΩ</div>
            </div>
            
            <i class="ph ph-gear text-text-muted group-hover:text-text-primary transition-colors" x-show="!sidebarCollapsed"></i>
        </a>
    </div>
</aside>