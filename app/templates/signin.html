<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Вход в MyService</title>
    <style>
        /* --- Базовые стили --- */
        * { box-sizing: border-box; }
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .login-card {
            background-color: #1a1a1a;
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }

        h2 { margin: 0 0 10px 0; font-weight: 700; font-size: 24px; }
        p.subtitle { color: #999; font-size: 15px; margin: 0 0 35px 0; }

        /* Кнопки и инпуты */
        .btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 14px; border-radius: 14px;
            text-decoration: none; font-weight: 600; font-size: 16px;
            border: none; cursor: pointer; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn svg { width: 24px; height: 24px; margin-right: 12px; }

        .btn-yandex { background-color: #2a2a2a; color: white; margin-bottom: 25px; padding: 16px; font-size: 17px; }
        .btn-yandex:hover { background-color: #333; }

        .btn-secondary { background-color: #2a2a2a; color: #cccccc; margin-bottom: 12px; font-weight: 500; }
        .btn-secondary:hover { background-color: #333; color: #fff; }
        .btn-secondary svg { fill: #999; }

        .btn-primary { background-color: #27ae60; color: white; margin-top: 15px; }
        .btn-primary:hover { background-color: #219150; }
        .btn-primary:disabled { background-color: #444; color: #888; cursor: not-allowed; }

        /* Соцсети */
        .social-divider { color: #555; font-size: 13px; margin: 25px 0; display: flex; align-items: center; }
        .social-divider::before, .social-divider::after { content: ""; flex: 1; border-bottom: 1px solid #333; margin: 0 10px; }
        .social-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .social-icon { background-color: #2a2a2a; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .social-icon:hover { background-color: #333; transform: translateY(-2px); }

        /* ФОРМА EMAIL (Скрытая по умолчанию) */
        #email-section { display: none; text-align: left; animation: fadeIn 0.3s ease; }
        
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; color: #888; font-size: 13px; margin-bottom: 5px; margin-left: 5px; }
        .form-input { 
            width: 100%; padding: 14px; background: #2a2a2a; border: 1px solid #333; 
            border-radius: 12px; color: white; font-size: 16px; outline: none; transition: 0.2s;
        }
        .form-input:focus { border-color: #27ae60; background: #222; }
        
        .back-btn { 
            background: none; border: none; color: #777; width: 100%; margin-top: 15px; 
            cursor: pointer; font-size: 14px; 
        }
        .back-btn:hover { color: #aaa; }

        #code-input-group { display: none; }
        #email-error { color: #e74c3c; font-size: 13px; margin-top: 10px; text-align: center; display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .footer-links { margin-top: 35px; font-size: 12px; color: #666; line-height: 1.5; }
        .footer-links a { color: #888; text-decoration: none; border-bottom: 1px dotted #555; }
    </style>
</head>
<body>

<div class="login-card">
    <div id="social-login-block">
        <h2>Вход в MyService</h2>
        <p class="subtitle">Выберите способ авторизации</p>

        <a href="/login/yandex-direct" class="btn btn-yandex">
            <svg width="28" height="28" viewBox="0 0 44 44" fill="none"><rect width="44" height="44" rx="22" fill="#FC3F1D"></rect><path d="M25.2438 12.3208H23.0173C19.2005 12.3208 17.292 14.2292 17.292 17.0919C17.292 20.2726 18.5643 21.863 21.427 23.7714L23.6535 25.3618L17.292 35.222H12.2029L18.2463 26.316C14.7475 23.7714 12.839 21.5449 12.839 17.41C12.839 12.3208 16.3378 8.82202 23.0173 8.82202H29.6969V35.222H25.2438V12.3208Z" fill="white"></path></svg>
            Войти через Яндекс
        </a>

        <div class="social-row">
            <a href="/login/google-direct" class="social-icon" title="Google">
                <svg width="28" height="28" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            </a>
            <a href="/login/vk-direct" class="social-icon" title="ВКонтакте" style="background-color: #0077FF;">
                <svg xmlns="http://www.w3.org/2000/svg" height="28" width="28" viewBox="0 0 48 48"><path d="M0 23.04C0 12.1788 0 6.74826 3.37413 3.37413C6.74826 0 12.1788 0 23.04 0H24.96C35.8212 0 41.2517 0 44.6259 3.37413C48 6.74826 48 12.1788 48 23.04V24.96C48 35.8212 48 41.2517 44.6259 44.6259C41.2517 48 35.8212 48 24.96 48H23.04C12.1788 48 6.74826 48 3.37413 44.6259C0 41.2517 0 35.8212 0 24.96V23.04Z" fill="#0077FF"></path><path d="M25.54 34.5801C14.6 34.5801 8.3601 27.0801 8.1001 14.6001H13.5801C13.7601 23.7601 17.8 27.6401 21 28.4401V14.6001H26.1602V22.5001C29.3202 22.1601 32.6398 18.5601 33.7598 14.6001H38.9199C38.0599 19.4801 34.4599 23.0801 31.8999 24.5601C34.4599 25.7601 38.5601 28.9001 40.1201 34.5801H34.4399C33.2199 30.7801 30.1802 27.8401 26.1602 27.4401V34.5801H25.54Z" fill="#ffffff"></path></svg>
            </a>
            <a href="#" onclick="alert('Скоро подключим!')" class="social-icon" title="Telegram" style="background-color: #2AABEE;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.692-1.653-1.123-2.678-1.799-1.185-.781-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.008-1.252-.241-1.865-.44-.751-.244-1.349-.374-1.297-.789.027-.216.324-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.014 3.333-1.386 4.025-1.627 4.477-1.635.1 0 .32.02.47.14.12.1.17.28.17.43z"/></svg>
            </a>
        </div>

        <div class="social-divider">другие способы</div>

        <button onclick="showEmailForm()" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            Через эл.почту
        </button>
        <a href="/login/password" onclick="alert('Это мы тоже прикрутим позже, если надо')" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4h-10.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
            У меня есть пароль
        </a>
    </div>

    <div id="email-section">
        <h2 id="email-title">Вход по почте</h2>
        <p class="subtitle" id="email-subtitle">Введите ваш email адрес</p>
        
        <div class="input-group">
            <label class="input-label">Email</label>
            <input type="email" id="email-input" class="form-input" placeholder="mail@example.com">
        </div>
        
        <div id="code-input-group" class="input-group">
            <label class="input-label">Код из письма</label>
            <input type="number" id="code-input" class="form-input" placeholder="1234">
        </div>

        <button id="email-action-btn" class="btn btn-primary" onclick="handleEmailAction()">
            Получить код
        </button>
        
        <div id="email-error"></div>

        <button class="back-btn" onclick="showSocialLogin()">
            ← Назад к выбору
        </button>
    </div>

    <div class="footer-links">
        Нажимая кнопку, вы принимаете <a href="#">Пользовательское соглашение</a>
    </div>
</div>

<script>
    let step = 1; // 1 = ввод email, 2 = ввод кода

    function showEmailForm() {
        document.getElementById('social-login-block').style.display = 'none';
        document.getElementById('email-section').style.display = 'block';
        document.getElementById('email-input').focus();
    }

    function showSocialLogin() {
        document.getElementById('email-section').style.display = 'none';
        document.getElementById('social-login-block').style.display = 'block';
        resetEmailForm();
    }

    function resetEmailForm() {
        step = 1;
        document.getElementById('code-input-group').style.display = 'none';
        document.getElementById('email-input').disabled = false;
        document.getElementById('email-action-btn').innerText = "Получить код";
        document.getElementById('email-title').innerText = "Вход по почте";
        document.getElementById('email-subtitle').innerText = "Введите ваш email адрес";
        document.getElementById('email-error').innerText = "";
        document.getElementById('email-error').style.display = 'none';
    }

    async function handleEmailAction() {
        const email = document.getElementById('email-input').value;
        const errorDiv = document.getElementById('email-error');
        const btn = document.getElementById('email-action-btn');

        if (!email.includes('@')) {
            showError('Введите корректный email');
            return;
        }

        errorDiv.style.display = 'none';
        btn.disabled = true;

        if (step === 1) {
            // ШАГ 1: Отправляем код
            btn.innerText = "Отправка...";
            try {
                const res = await fetch('/auth/email/request-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: email })
                });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);

                // Успех, переходим к шагу 2
                step = 2;
                document.getElementById('code-input-group').style.display = 'block';
                document.getElementById('email-input').disabled = true;
                document.getElementById('email-action-btn').innerText = "Войти";
                document.getElementById('email-title').innerText = "Введите код";
                document.getElementById('email-subtitle').innerText = "Мы отправили код на вашу почту";
                document.getElementById('code-input').focus();

            } catch (e) {
                showError(e.message || "Ошибка сервера");
            } finally {
                btn.disabled = false;
                if(step === 1) btn.innerText = "Получить код";
            }
        } else {
            // ШАГ 2: Проверяем код
            const code = document.getElementById('code-input').value;
            if (code.length < 4) {
                showError("Введите полный код");
                btn.disabled = false;
                return;
            }

            btn.innerText = "Проверка...";
            try {
                const res = await fetch('/auth/email/verify-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: email, code: code })
                });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);

                // Успех!
                window.location.href = "/";

            } catch (e) {
                showError(e.message || "Неверный код");
                btn.innerText = "Войти";
                btn.disabled = false;
            }
        }
    }

    function showError(msg) {
        const el = document.getElementById('email-error');
        el.innerText = msg;
        el.style.display = 'block';
    }
</script>

</body>
</html>