{% extends "layouts/base.html" %}

{% block title %}Вход — Neirosetim{% endblock %}

{% block content %}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-fade-in">
    
    <div class="relative w-full max-w-[420px] bg-[#18181b] rounded-[32px] p-6 sm:p-8 text-center shadow-2xl flex flex-col justify-center transition-all duration-300">
        
        <a href="/" class="absolute top-5 right-5 text-[#71717a] hover:text-white transition-colors p-2 z-10">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </a>

        <div id="social-login-block" class="flex flex-col h-full justify-center">
            
            <h1 class="text-[26px] font-bold text-white mb-1 leading-tight">
                Войти или <br> зарегистрироваться
            </h1>
            <p class="text-[#71717a] text-sm font-medium mb-6">
                используя социальную сеть
            </p>

            <div class="flex justify-center mb-8 text-[#52525b]">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14M19 12l-7 7-7-7"/>
                </svg>
            </div>

            <div class="space-y-4 w-full">
                <a href="/login/yandex-direct" class="group flex items-center justify-center w-full py-3.5 px-6 bg-[#27272a] hover:bg-[#3f3f46] rounded-[24px] transition-all gap-3 relative overflow-hidden">
                    <div class="w-7 h-7 flex-shrink-0">
                        <svg viewBox="0 0 44 44" fill="none" class="w-full h-full"><rect width="44" height="44" rx="22" fill="#FC3F1D"></rect><path d="M25.2438 12.3208H23.0173C19.2005 12.3208 17.292 14.2292 17.292 17.0919C17.292 20.2726 18.5643 21.863 21.427 23.7714L23.6535 25.3618L17.292 35.222H12.2029L18.2463 26.316C14.7475 23.7714 12.839 21.5449 12.839 17.41C12.839 12.3208 16.3378 8.82202 23.0173 8.82202H29.6969V35.222H25.2438V12.3208Z" fill="white"></path></svg>
                    </div>
                    <span class="text-white font-bold text-lg tracking-wide group-hover:text-white transition-colors">
                        Войти через Яндекс
                    </span>
                </a>

                <div class="flex justify-center items-center gap-5 py-2">
                    <a href="/login/google-direct" class="w-[60px] h-[60px] flex items-center justify-center rounded-full bg-[#27272a] hover:bg-[#3f3f46] transition-all group" title="Google">
                        <svg class="w-7 h-7 transition-transform group-hover:scale-110" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    </a>
                    
                    <div class="relative w-[60px] h-[60px] flex items-center justify-center rounded-full bg-[#27272a] hover:bg-[#3f3f46] transition-all overflow-hidden cursor-pointer group">
                        <svg class="w-8 h-8 transition-transform group-hover:scale-110" viewBox="0 0 24 24" fill="#2AABEE"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.692-1.653-1.123-2.678-1.799-1.185-.781-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.008-1.252-.241-1.865-.44-.751-.244-1.349-.374-1.297-.789.027-.216.324-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.014 3.333-1.386 4.025-1.627 4.477-1.635.1 0 .32.02.47.14.12.1.17.28.17.43z"/></svg>
                        <div class="absolute inset-0 opacity-0 z-10 scale-[2]">
                             <script async src="https://telegram.org/js/telegram-widget.js?22" 
                                    data-telegram-login="neirosetim_bot" 
                                    data-size="large" 
                                    data-userpic="false" 
                                    data-radius="0" 
                                    data-auth-url="/callback/telegram" 
                                    data-request-access="write">
                            </script>
                        </div>
                    </div>

                    <a href="/login/vk-direct" class="w-[60px] h-[60px] flex items-center justify-center rounded-full bg-[#27272a] hover:bg-[#3f3f46] transition-all group" title="ВКонтакте">
                        <svg class="w-8 h-8 transition-transform group-hover:scale-110" viewBox="0 0 48 48"><path d="M0 23.04C0 12.1788 0 6.74826 3.37413 3.37413C6.74826 0 12.1788 0 23.04 0H24.96C35.8212 0 41.2517 0 44.6259 3.37413C48 6.74826 48 12.1788 48 23.04V24.96C48 35.8212 48 41.2517 44.6259 44.6259C41.2517 48 35.8212 48 24.96 48H23.04C12.1788 48 6.74826 48 3.37413 44.6259C0 41.2517 0 35.8212 0 24.96V23.04Z" fill="#0077FF"></path><path d="M25.54 34.5801C14.6 34.5801 8.3601 27.0801 8.1001 14.6001H13.5801C13.7601 23.7601 17.8 27.6401 21 28.4401V14.6001H26.1602V22.5001C29.3202 22.1601 32.6398 18.5601 33.7598 14.6001H38.9199C38.0599 19.4801 34.4599 23.0801 31.8999 24.5601C34.4599 25.7601 38.5601 28.9001 40.1201 34.5801H34.4399C33.2199 30.7801 30.1802 27.8401 26.1602 27.4401V34.5801H25.54Z" fill="#ffffff"></path></svg>
                    </a>
                </div>

                <div class="text-[#52525b] text-sm py-2 font-medium">
                    - или -
                </div>

                <button onclick="showEmailForm()" class="flex items-center justify-center gap-3 w-full py-3.5 px-6 bg-[#27272a] hover:bg-[#3f3f46] rounded-[24px] text-white font-semibold transition-all group">
                    <svg class="text-[#71717a] group-hover:text-white transition-colors" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                    Через эл.почту
                </button>
            </div>

            <div class="mt-8 px-2 text-[11px] text-[#52525b] leading-tight">
                Нажимая на одну из кнопок, я принимаю
                <a href="/privacy" class="underline hover:text-[#a1a1aa] transition-colors">Пользовательское соглашение</a>,
                <a href="/policy" class="underline hover:text-[#a1a1aa] transition-colors">Политику обработки персональных данных</a> и даю
                <a href="/consent" class="underline hover:text-[#a1a1aa] transition-colors">Согласие</a> на их обработку
            </div>
        </div>


        <div id="email-section" class="hidden flex-col h-full items-center w-full animate-fade-in">
            <h2 id="email-title" class="text-2xl font-bold mb-8 text-white">Вход по почте</h2>
            <p id="email-subtitle" class="hidden text-[#a1a1aa] mb-6 text-sm">Введите ваш email адрес</p>
            
            <div class="w-full flex-1 flex flex-col items-center">
                
                <div id="email-input-wrapper" class="w-full mb-6">
                    <input type="email" id="email-input" 
                           class="w-full p-4 bg-[#27272a] rounded-[16px] text-white text-lg placeholder-[#52525b] border border-transparent focus:border-[#52525b] outline-none transition-all" 
                           placeholder="Эл.Почта">
                </div>
                
                <div id="code-input-group" class="hidden w-full mb-6">
    <input type="hidden" id="code-input">
    
    <div class="flex justify-center gap-3 sm:gap-4" id="otp-container">
        <input type="text" maxlength="1" class="otp-digit w-16 h-20 bg-[#27272a] border border-transparent rounded-2xl text-center text-white text-3xl font-bold focus:border-[#a855f7] focus:bg-[#3f3f46] outline-none transition-all caret-transparent shadow-inner" inputmode="numeric">
        <input type="text" maxlength="1" class="otp-digit w-16 h-20 bg-[#27272a] border border-transparent rounded-2xl text-center text-white text-3xl font-bold focus:border-[#a855f7] focus:bg-[#3f3f46] outline-none transition-all caret-transparent shadow-inner" inputmode="numeric">
        <input type="text" maxlength="1" class="otp-digit w-16 h-20 bg-[#27272a] border border-transparent rounded-2xl text-center text-white text-3xl font-bold focus:border-[#a855f7] focus:bg-[#3f3f46] outline-none transition-all caret-transparent shadow-inner" inputmode="numeric">
        <input type="text" maxlength="1" class="otp-digit w-16 h-20 bg-[#27272a] border border-transparent rounded-2xl text-center text-white text-3xl font-bold focus:border-[#a855f7] focus:bg-[#3f3f46] outline-none transition-all caret-transparent shadow-inner" inputmode="numeric">
    </div>
    </div>

                <button id="email-action-btn" class="w-full py-4 bg-[#27272a] hover:bg-[#3f3f46] text-white rounded-[24px] font-medium transition-all flex items-center justify-center gap-2 group" onclick="handleEmailAction()">
                    <span>Продолжить</span>
                    <svg class="text-[#71717a] group-hover:translate-x-1 transition-transform" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
                
                <div id="email-error" class="text-red-500 text-sm mt-4 min-h-[20px] text-center"></div>

                <div class="mt-8 w-full p-4 bg-[#27272a]/50 rounded-[20px] text-[#71717a] text-xs leading-relaxed text-center">
                    <span id="footer-info-text">Мы отправим письмо с одноразовым кодом, который нужно будет ввести.</span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const otpInputs = document.querySelectorAll('.otp-digit');
        const hiddenInput = document.getElementById('code-input');

        otpInputs.forEach((input, index) => {
            // Ввод цифр
            input.addEventListener('input', (e) => {
                if(e.target.value.length > 1) {
                    e.target.value = e.target.value.slice(0, 1);
                }
                if(e.target.value.length === 1) {
                    if(index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                }
                updateHiddenInput();
            });

            // Backspace навигация
            input.addEventListener('keydown', (e) => {
                if(e.key === 'Backspace' && !e.target.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
            
            // Вставка кода из буфера (Paste)
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                if(!/^\d+$/.test(text)) return;
                
                const digits = text.split('');
                otpInputs.forEach((inp, i) => {
                    if(digits[i]) inp.value = digits[i];
                });
                updateHiddenInput();
                // Фокус на последнее заполненное или на последнее поле
                const focusIndex = Math.min(digits.length, otpInputs.length) - 1;
                if(focusIndex >= 0) otpInputs[focusIndex].focus();
            });
        });

        function updateHiddenInput() {
            let code = '';
            otpInputs.forEach(input => code += input.value);
            hiddenInput.value = code;
        }
        
        // Хук для изменения текста в footer при переключении шага
        const originalFetch = window.fetch;
        // Мы наблюдаем за мутациями DOM или переопределяем функцию показа
        // Но проще всего добавить логику в существующий signin.js, 
        // или использовать MutationObserver здесь, чтобы поменять текст внизу.
        
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'code-input-group' && !mutation.target.classList.contains('hidden')) {
                     // Шаг 2 активен: меняем заголовок и подвал
                     document.getElementById('email-title').innerText = 'Одноразовый код';
                     document.getElementById('email-input-wrapper').classList.add('hidden');
                     
                     const emailVal = document.getElementById('email-input').value;
                     document.getElementById('footer-info-text').innerHTML = `Письмо отправлено на <span class="text-white">${emailVal}</span>. Если нет письма, возможно оно в папке "Спам" или ящик переполнен.`;
                     
                     // Фокус на первую цифру
                     setTimeout(() => otpInputs[0].focus(), 100);
                }
            });
        });
        
        const codeGroup = document.getElementById('code-input-group');
        if(codeGroup) {
            observer.observe(codeGroup, { attributes: true, attributeFilter: ['class'] });
        }
    });
</script>
{% endblock %}

{% block scripts %}
<script src="/static/js/signin.js"></script>
{% endblock %}