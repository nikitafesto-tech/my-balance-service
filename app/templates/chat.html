{% extends "base_app.html" %}

{% block content %}
<div x-data="appLogic()" class="flex w-full h-full relative" x-cloak>

    <aside 
        class="flex flex-col w-72 h-full bg-sidebar border-r border-white/5 z-40 transition-transform duration-300 absolute md:relative"
        :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
    >
        <div class="p-4 flex items-center justify-between">
            <a href="/" class="flex items-center gap-2 font-bold text-xl tracking-tight">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
                <span>Neirosetim</span>
            </a>
            <button @click="sidebarOpen = false" class="md:hidden text-gray-400 hover:text-white">
                <i class="ph ph-x text-2xl"></i>
            </button>
        </div>

        <div class="px-4 mb-4">
            <button @click="startNewChat()" class="w-full flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 rounded-xl transition-colors border border-white/5 text-sm font-medium">
                <i class="ph ph-plus text-lg"></i>
                –ù–æ–≤—ã–π —á–∞—Ç
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-2 space-y-1">
            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">–ò—Å—Ç–æ—Ä–∏—è</div>
            <template x-for="chat in chatHistory" :key="chat.id">
                <button @click="loadChat(chat.id)" class="w-full text-left flex items-center gap-3 px-3 py-3 rounded-lg transition group" :class="activeChatId === chat.id ? 'bg-white/10 text-white' : 'text-gray-400 hover:bg-white/5 hover:text-white'">
                    <i class="ph ph-chat-circle text-lg"></i>
                    <div class="flex-1 truncate text-sm" x-text="chat.title"></div>
                </button>
            </template>
        </div>

        <div class="p-4 border-t border-white/5">
            <a href="/profile" class="flex items-center gap-3 hover:bg-white/5 p-2 rounded-xl transition cursor-pointer">
                {% if avatar %}
                    <img src="{{ avatar }}" class="w-9 h-9 rounded-full object-cover">
                {% else %}
                    <div class="w-9 h-9 rounded-full bg-gray-700 flex items-center justify-center">üë§</div>
                {% endif %}
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">{{ name }}</div>
                    <div class="text-xs text-green" x-text="(balance || 0).toFixed(2) + ' ‚ÇΩ'">{{ balance }} ‚ÇΩ</div>
                </div>
                <i class="ph ph-gear text-gray-400"></i>
            </a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative min-w-0 bg-dark">
        <header class="h-14 flex items-center justify-between px-4 border-b border-white/5 flex-shrink-0 md:hidden">
            <button @click="sidebarOpen = true" class="p-2 text-gray-400 hover:text-white"><i class="ph ph-list text-2xl"></i></button>
            <span class="font-semibold text-sm">Neirosetim AI</span>
            <div class="w-8"></div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6" id="chat-container">
            <div x-show="messages.length === 0 && !activeChatId" class="h-full flex flex-col items-center justify-center text-center">
                <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mb-6">
                    <div class="w-10 h-10 fill-white opacity-80" x-html="getCurrentGroupIcon()"></div>
                </div>
                <h2 class="text-2xl font-bold mb-2">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</h2>
                <div class="text-gray-500 max-w-md mb-8 flex items-center justify-center gap-2">
                    <span>–ú–æ–¥–µ–ª—å:</span>
                    <span class="text-green font-bold flex items-center gap-2">
                        <span x-text="currentModelName"></span>
                    </span>
                </div>
            </div>

            <template x-for="msg in messages" :key="msg.id">
                <div class="flex gap-4 max-w-4xl mx-auto group" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                    
                    <div x-show="msg.role === 'assistant'" class="w-8 h-8 rounded-full bg-green flex-shrink-0 flex items-center justify-center mt-1">
                        <i class="ph ph-robot text-white text-lg"></i>
                    </div>
                    
                    <div class="flex flex-col max-w-[85%]" :class="msg.role === 'user' ? 'items-end' : 'items-start'">
                        <div class="px-5 py-3.5 rounded-2xl text-[15px] leading-relaxed shadow-sm relative markdown-content" 
                             :class="msg.role === 'user' ? 'bg-white/10 text-white rounded-tr-sm' : 'bg-[#222] text-gray-100 pl-5'">
                            
                            <div x-html="parseMarkdown(msg.content)"></div>
                            
                            <span x-show="msg.isStreaming" class="inline-block w-2 h-4 bg-green ml-1 animate-pulse align-middle"></span>

                            <template x-if="msg.attachment_url">
                                <img :src="msg.attachment_url" class="mt-3 rounded-lg max-w-full max-h-64 border border-white/10 object-cover cursor-pointer" onclick="window.open(this.src)">
                            </template>
                            <template x-if="msg.image_url && !msg.image_url.endsWith('.mp4')">
                                <img :src="msg.image_url" class="mt-3 rounded-lg max-w-full max-h-64 border border-white/10 object-cover cursor-pointer" onclick="window.open(this.src)">
                            </template>
                            <template x-if="msg.image_url && msg.image_url.endsWith('.mp4')">
                                <div class="mt-3 rounded-lg overflow-hidden border border-white/10 w-full max-w-md">
                                    <video controls playsinline class="w-full"><source :src="msg.image_url" type="video/mp4"></video>
                                </div>
                            </template>
                        </div>

                        <div class="flex items-center gap-4 mt-2 px-1 text-xs text-gray-500 opacity-80 hover:opacity-100 transition-opacity">
                            <button @click="copyToClipboard(msg.content)" class="hover:text-white flex items-center gap-1 transition-colors">
                                <i class="ph ph-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button @click="replyToMessage(msg)" class="hover:text-white flex items-center gap-1 transition-colors">
                                <i class="ph ph-arrow-u-up-left"></i> –¶–∏—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </template>
            <div class="h-32"></div>
        </div>

        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-dark via-dark to-transparent pt-10 pb-6 px-4">
            <div class="max-w-3xl mx-auto relative">
                
                <div x-show="replyContext" x-transition class="absolute bottom-full left-0 right-0 mb-2 mx-4 bg-[#1a1a1a] border-l-4 border-green border-t border-r border-white/10 p-3 rounded-t-lg flex items-center justify-between shadow-xl z-20">
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-[10px] text-green font-bold uppercase tracking-wider mb-0.5">–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                        <span class="text-sm text-gray-300 truncate" x-text="replyContext?.preview"></span>
                    </div>
                    <button @click="replyContext = null" class="text-gray-500 hover:text-white p-1"><i class="ph ph-x"></i></button>
                </div>

                <div x-show="attachedFileUrl" x-transition class="absolute bottom-full left-0 mb-2 ml-2 bg-[#1a1a1a] border border-white/10 p-2 rounded-xl flex items-center gap-3 shadow-xl z-20">
                    <div class="relative group">
                        <img :src="attachedFileUrl" class="w-12 h-12 rounded-lg object-cover bg-black">
                        <button @click="attachedFileUrl = null; $refs.fileInput.value = ''" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow-sm hover:scale-110">‚úï</button>
                    </div>
                    <div class="text-xs text-gray-400 mr-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ<br>–ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ</div>
                </div>

                <div class="bg-sidebar border border-white/10 rounded-2xl shadow-lg flex flex-col transition-colors focus-within:border-white/20">
                    <textarea x-model="userInput" @keydown.enter.prevent="sendMessage()" rows="1" placeholder="–ó–∞–ø—Ä–æ—Å..." class="w-full bg-transparent text-white placeholder-gray-500 px-4 py-4 resize-none outline-none max-h-48 overflow-y-auto" style="min-height: 56px;" x-ref="chatInput" @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"></textarea>

                    <div class="flex items-center justify-between px-3 pb-3 pt-1">
                        <div class="flex items-center gap-2">
                            
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="flex items-center gap-2 bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-lg transition border border-white/5 text-xs sm:text-sm">
                                    <span x-html="getCurrentGroupIcon()" class="w-4 h-4 fill-white"></span>
                                    <span class="font-semibold" x-text="currentModelName">GPT-4o</span>
                                    <i class="ph ph-caret-down text-gray-500 transition-transform" :class="open ? 'rotate-180' : ''"></i>
                                </button>

                                <div x-show="open" @click.outside="open = false" x-transition class="absolute bottom-full left-0 mb-2 w-72 bg-[#1a1a1a] border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden max-h-[70vh] flex flex-col">
                                    <div class="p-2 overflow-y-auto custom-scrollbar flex-1 space-y-1">
                                        <template x-for="group in aiGroups" :key="group.name">
                                            <div class="mb-1">
                                                <button @click="group.isOpen = !group.isOpen" 
                                                        class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-sm font-semibold text-gray-300 hover:bg-white/5 hover:text-white transition-colors">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-5 h-5 fill-current opacity-90" x-html="group.icon"></div>
                                                        <span x-text="group.name"></span>
                                                    </div>
                                                    <i class="ph ph-caret-down text-xs text-gray-500 transition-transform" :class="group.isOpen ? 'rotate-180' : ''"></i>
                                                </button>

                                                <div x-show="group.isOpen" x-collapse class="pl-2 space-y-0.5 mt-1">
                                                    <template x-for="model in group.models" :key="model.id">
                                                        <button @click="setModel(model.id, model.name); open=false" 
                                                                class="w-full text-left px-3 py-2 rounded-lg text-xs text-gray-400 hover:text-white hover:bg-white/10 transition-colors ml-2 border-l border-white/5 flex justify-between items-center"
                                                                :class="currentModel === model.id ? 'text-green bg-green/5 border-green' : ''">
                                                            <span x-text="model.name"></span>
                                                            <i x-show="currentModel === model.id" class="ph ph-check text-green"></i>
                                                        </button>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <div class="relative" x-data="{ open: false }" x-show="canSearch">
                                <button @click="open = !open" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                                    <i class="ph ph-gear text-xl"></i>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-transition class="absolute bottom-full left-0 mb-2 w-64 bg-[#1a1a1a] border border-white/10 rounded-xl shadow-2xl z-50 p-3">
                                    <button @click="webSearch = !webSearch" class="w-full flex items-center justify-between px-3 py-2 rounded-lg border text-xs font-medium transition-all mb-3" :class="webSearch ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-white/5 border-transparent text-gray-400'">
                                        <div class="flex items-center gap-2"><i class="ph ph-globe text-lg"></i><span>–í–µ–±-–ø–æ–∏—Å–∫</span></div>
                                        <div class="w-8 h-4 rounded-full relative transition-colors" :class="webSearch ? 'bg-blue-500' : 'bg-gray-600'">
                                            <div class="w-2 h-2 bg-white rounded-full absolute top-1 transition-all" :style="webSearch ? 'right: 4px' : 'left: 4px'"></div>
                                        </div>
                                    </button>
                                    <div class="text-xs text-gray-400 mb-1 flex justify-between"><span>–¢–æ—á–Ω–æ—Å—Ç—å</span><span>–ö—Ä–µ–∞—Ç–∏–≤</span></div>
                                    <input type="range" min="0" max="1" step="0.1" x-model="temperature" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>

                            <div x-show="canVision">
                                <input type="file" x-ref="fileInput" class="hidden" @change="uploadFile($event)">
                                <button @click="$refs.fileInput.click()" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-lg transition" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å" :disabled="isUploading">
                                    <i class="ph ph-paperclip text-xl" x-show="!isUploading"></i>
                                    <i class="ph ph-spinner text-xl animate-spin text-green" x-show="isUploading" x-cloak></i>
                                </button>
                            </div>
                        </div>

                        <button @click="sendMessage()" class="p-2 rounded-xl transition-all duration-200" :class="userInput.trim() || attachedFileUrl ? 'bg-white text-black hover:bg-gray-200' : 'bg-white/10 text-gray-500 cursor-not-allowed'" :disabled="!userInput.trim() && !attachedFileUrl">
                            <i class="ph ph-arrow-up text-xl font-bold"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #1a1a1a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

    details.reasoning { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
    details.reasoning summary { padding: 10px 14px; cursor: pointer; font-size: 13px; font-weight: 500; color: #888; list-style: none; display: flex; align-items: center; gap: 8px; transition: color 0.2s; }
    details.reasoning summary:hover { color: #ccc; background: rgba(255,255,255,0.02); }
    details.reasoning summary::before { content: "‚ö°"; font-size: 14px; opacity: 0.7; }
    details.reasoning[open] summary { border-bottom: 1px solid rgba(255,255,255,0.05); }
    .reasoning-content { padding: 14px; font-size: 13px; color: #a0a0a0; font-family: 'Menlo', monospace; line-height: 1.6; white-space: pre-wrap; background: rgba(0,0,0,0.2); }

    .code-wrapper { margin: 12px 0; border: 1px solid #333; border-radius: 8px; overflow: hidden; background: #161616; }
    .code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #252525; border-bottom: 1px solid #333; font-family: sans-serif; font-size: 12px; color: #999; }
    .copy-code-btn { cursor: pointer; display: flex; align-items: center; gap: 4px; color: #777; transition: color 0.2s; }
    .copy-code-btn:hover { color: #fff; }
    
    .markdown-content pre { margin: 0; border: none; background: transparent !important; border-radius: 0; }
    .markdown-content pre code { display: block; padding: 16px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.5; overflow-x: auto; }
</style>

<script>
    const MODEL_CAPABILITIES = {
        'default': { vision: true, web: true },
        'recraft-v3': { vision: false, web: false },
        'flux-1.1-ultra': { vision: false, web: false },
        'veo-3.1': { vision: false, web: false },
        'midjourney': { vision: false, web: false },
        'luma-ray-2': { vision: false, web: false },
        'o1-preview': { vision: false, web: false },
        'o1-mini': { vision: false, web: false },
        'deepseek-r1': { vision: false, web: false },
    };

    function appLogic() {
        return {
            sidebarOpen: false, isTyping: false, isUploading: false,
            currentModel: 'openai/gpt-4o', currentModelName: 'GPT-4o',
            userInput: '', attachedFileUrl: null,
            activeChatId: null, chatHistory: [], messages: [],
            temperature: 0.7, webSearch: false,
            replyContext: null,
            aiGroups: [], // –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞

            balance: parseFloat("{{ balance | default(0) }}"),

            get canVision() { return (MODEL_CAPABILITIES[this.currentModel] || MODEL_CAPABILITIES['default']).vision; },
            get canSearch() { return (MODEL_CAPABILITIES[this.currentModel] || MODEL_CAPABILITIES['default']).web; },
            
            getCurrentGroupIcon() {
                if (!this.aiGroups || this.aiGroups.length === 0) return "";
                for (const group of this.aiGroups) {
                    if (group.models.find(m => m.id === this.currentModel)) {
                        return group.icon;
                    }
                }
                return this.aiGroups[0].icon;
            },

            async init() { 
                await this.loadModels(); 
                await this.loadHistory(); 
            },

            async loadModels() {
                try {
                    const res = await fetch('/api/chats/models');
                    if (res.ok) {
                        this.aiGroups = await res.json();
                        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω–∞, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é
                        if (!this.currentModel && this.aiGroups.length > 0) {
                             const first = this.aiGroups[0].models[0];
                             this.setModel(first.id, first.name);
                        }
                    }
                } catch (e) {
                    console.error("Models load error", e);
                }
            },

            async loadHistory() { try { const res = await fetch('/api/chats'); if (res.ok) this.chatHistory = await res.json(); } catch (e) {} },
            
            async loadChat(id) { 
                this.activeChatId = id; 
                this.messages = []; 
                this.sidebarOpen = false; 
                
                try { 
                    const res = await fetch(`/api/chats/${id}`); 
                    if (res.ok) { 
                        const data = await res.json();
                        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ß–∏—Ç–∞–µ–º messages –∏–∑ –æ–±—ä–µ–∫—Ç–∞
                        this.messages = data.messages || []; 
                        
                        if (data.model) {
                            let foundName = data.model;
                            if (this.aiGroups.length > 0) {
                                for (const group of this.aiGroups) {
                                    const m = group.models.find(x => x.id === data.model);
                                    if (m) foundName = m.name;
                                }
                            }
                            // –¢–∏—Ö–æ –æ–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –±–µ–∑ —Å–±—Ä–æ—Å–∞ —á–∞—Ç–∞
                            this.currentModel = data.model;
                            this.currentModelName = foundName;
                        }
                        
                        this.scrollToBottom(); 
                    } 
                } catch (e) {
                    console.error("Failed to load chat", e);
                } 
            },
            
            setModel(id, name) { 
                this.currentModel = id; 
                this.currentModelName = name; 
                if (this.messages.length > 0 && this.activeChatId) this.startNewChat(); 
            },
            
            startNewChat() { this.activeChatId = null; this.messages = []; this.userInput = ''; this.attachedFileUrl = null; this.replyContext = null; this.$nextTick(() => this.$refs.chatInput.focus()); },
            
            copyToClipboard(text) { navigator.clipboard.writeText(text); },
            
            replyToMessage(msg) {
                const preview = msg.content.substring(0, 60) + (msg.content.length > 60 ? '...' : '');
                this.replyContext = { id: msg.id, content: msg.content, preview: preview };
                this.$refs.chatInput.focus();
            },

            async sendMessage() {
                if (!this.userInput.trim() && !this.attachedFileUrl) return;
                
                let textToSend = this.userInput;
                if (this.replyContext) {
                    const quotePrefix = this.replyContext.content.split('\n').map(line => `> ${line}`).join('\n');
                    textToSend = `${quotePrefix}\n\n${this.userInput}`;
                }

                const fileUrl = this.attachedFileUrl;
                this.userInput = ''; this.attachedFileUrl = null; this.replyContext = null; 
                this.$refs.chatInput.style.height = 'auto';

                const userMsgId = Date.now();
                this.messages.push({ role: 'user', content: textToSend, attachment_url: fileUrl, id: userMsgId });
                
                const botMsgId = userMsgId + 1;
                this.messages.push({ role: 'assistant', content: '', id: botMsgId, isStreaming: true });
                
                this.scrollToBottom(); 
                this.isTyping = true;

                try {
                    const payload = { 
                        message: textToSend, model: this.currentModel, temperature: parseFloat(this.temperature), 
                        web_search: this.webSearch && this.canSearch, attachment_url: fileUrl 
                    };
                    
                    let url = !this.activeChatId ? '/api/chats/new' : `/api/chats/${this.activeChatId}/message`;
                    
                    const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if (response.status === 402) {
                        const errData = await response.json();
                        const msg = this.messages.find(m => m.id === botMsgId);
                        if(msg) { msg.content = "‚õî " + errData.detail; msg.isStreaming = false; }
                        return;
                    }

                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        const data = await response.json();
                        if (!this.activeChatId && data.chat_id) { this.activeChatId = data.chat_id; await this.loadHistory(); }
                        if (data.balance !== undefined) { this.balance = data.balance; }

                        const msgIndex = this.messages.findIndex(m => m.id === botMsgId);
                        if(msgIndex !== -1) {
                            const lastMsg = data.messages[data.messages.length - 1];
                            this.messages[msgIndex] = { ...this.messages[msgIndex], content: lastMsg.content, image_url: lastMsg.image_url, isStreaming: false };
                        }
                    } 
                    else {
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let botText = "";

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            for (const line of lines) {
                                if (!line.trim()) continue;
                                try {
                                    const json = JSON.parse(line);
                                    if (json.type === 'meta' && !this.activeChatId) {
                                        this.activeChatId = json.chat_id;
                                        this.loadHistory();
                                    }
                                    else if (json.type === 'content') {
                                        botText += json.text;
                                        const msg = this.messages.find(m => m.id === botMsgId);
                                        if(msg) msg.content = botText;
                                        this.scrollToBottom();
                                    }
                                    else if (json.type === 'balance') {
                                        this.balance = json.balance;
                                    }
                                    else if (json.type === 'error') {
                                        botText += `\n[–û—à–∏–±–∫–∞: ${json.text}]`;
                                        const msg = this.messages.find(m => m.id === botMsgId);
                                        if(msg) msg.content = botText;
                                    }
                                } catch (e) {}
                            }
                        }
                        const msg = this.messages.find(m => m.id === botMsgId);
                        if(msg) msg.isStreaming = false;
                    }

                } catch (e) { 
                    const msg = this.messages.find(m => m.id === botMsgId);
                    if(msg) { msg.content = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.'; msg.isStreaming = false; }
                } finally { 
                    this.isTyping = false; this.scrollToBottom(); 
                }
            },

            async uploadFile(event) {
                const file = event.target.files[0]; if (!file) return;
                
                this.isUploading = true; 
                
                const formData = new FormData(); formData.append('file', file);
                try { 
                    const res = await fetch('/api/upload', { method: 'POST', body: formData }); 
                    const data = await res.json(); 
                    if(data.url) { 
                        this.attachedFileUrl = data.url; 
                        this.$refs.fileInput.value = ''; 
                    } 
                } catch(e) { 
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); 
                } finally {
                    this.isUploading = false;
                }
            },

            parseMarkdown(text) {
                if (!text) return "";
                text = text.replace(/<think>([\s\S]*?)<\/think>/g, '<details class="reasoning"><summary>–†–∞–∑–º—ã—à–ª–µ–Ω–∏—è</summary><div class="reasoning-content">$1</div></details>');
                let html = marked.parse(text);
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                doc.querySelectorAll('pre code').forEach((block) => {
                    let lang = "Code";
                    block.classList.forEach(cls => { if (cls.startsWith('language-')) lang = cls.replace('language-', ''); });
                    
                    const pre = block.parentElement;
                    const wrapper = document.createElement('div'); wrapper.className = 'code-wrapper';
                    const header = document.createElement('div'); header.className = 'code-header';
                    header.innerHTML = `<span>${lang}</span> <span class="copy-code-btn" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>`;
                    
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(header); wrapper.appendChild(pre);
                    hljs.highlightElement(block);
                });
                return doc.body.innerHTML;
            },
            
            scrollToBottom() { this.$nextTick(() => { const el = document.getElementById('chat-container'); el.scrollTop = el.scrollHeight; }); }
        }
    }
</script>
{% endblock %}